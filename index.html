<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            overscroll-behavior: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px; /* Espacio para la barra inferior */
        }
        
        .progress-container {
            height: 5px;
            background-color: #333;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #1DB954;
            border-radius: 5px;
            transition: width 0.1s;
        }
        
        .music-controls button {
            transition: transform 0.1s;
        }
        
        .music-controls button:active {
            transform: scale(0.95);
        }
        
        .playlist-item {
            transition: background-color 0.2s;
        }
        
        .playlist-item:active {
            background-color: #333;
        }
        
        .visualizer-container {
            height: 60px;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            padding: 0 5px;
        }
        
        .visualizer-bar {
            width: 3px;
            background-color: #1DB954;
            margin: 0 1px;
            border-radius: 2px 2px 0 0;
            transition: height 0.1s ease;
        }
        
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 5px;
            border-radius: 5px;
            background: #333;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
        }
        
        .volume-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
        }
        
        .tab-active {
            color: #1DB954;
            border-bottom: 2px solid #1DB954;
        }
        
        .custom-file-upload {
            display: inline-block;
            padding: 10px 15px;
            cursor: pointer;
            background-color: #1DB954;
            color: white;
            border-radius: 5px;
            text-align: center;
            transition: background-color 0.3s;
        }
        
        .custom-file-upload:hover {
            background-color: #18a348;
        }
        
        #fileInput {
            display: none;
        }
        
        .eq-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 60px;
            margin: 0;
            transform: rotate(270deg);
            background: transparent;
        }
        
        .eq-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 15px;
            width: 15px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
            margin-top: -5px;
        }
        
        .eq-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 5px;
            background: #333;
            border-radius: 3px;
        }
        
        .eq-container {
            display: flex;
            justify-content: space-around;
            height: 80px;
            align-items: center;
        }
        
        .eq-band {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .playing {
            color: #1DB954;
            animation: pulse 2s infinite;
        }
        
        /* Arreglos para problemas de superposici√≥n */
        .header-spacer {
            height: 120px; /* Altura del header + tabs */
        }
        
        .main-container {
            padding-bottom: 80px; /* Espacio para la barra inferior */
            padding-top: 20px; /* Espacio adicional en la parte superior */
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #1DB954;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* Auth container styles */
        #authContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1.5rem;
            background-color: #121212;
        }
        
        .auth-tab {
            width: 50%;
            text-align: center;
            padding: 1rem;
            cursor: pointer;
        }
        
        .auth-tab.active {
            color: white;
            border-bottom: 2px solid #1DB954;
        }
        
        .auth-tab:not(.active) {
            color: #888;
            border-bottom: 2px solid transparent;
        }
        
        .auth-form {
            display: none;
            width: 100%;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .auth-input {
            width: 100%;
            padding: 1rem;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        .auth-button {
            width: 100%;
            padding: 1rem;
            background-color: #1DB954;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .auth-button:hover {
            background-color: #18a348;
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: #888;
        }
        
        .divider::before,
        .divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background-color: #333;
        }
        
        .divider span {
            padding: 0 1rem;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            min-width: 300px;
        }
        
        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #1DB954;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a2a2a;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #1DB954;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            border-left-color: #e74c3c;
        }
        
        .notification.success {
            border-left-color: #2ecc71;
        }
        
        /* Upload progress */
        .upload-progress-container {
            background-color: #333;
            height: 10px;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .upload-progress-bar {
            height: 100%;
            background-color: #1DB954;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 id="loadingTitle">Cargando...</h3>
            <p id="loadingMessage">Por favor espera...</p>
        </div>
    </div>
    
    <!-- Notification Toast -->
    <div id="notification" class="notification">
        <div id="notificationMessage">Mensaje de notificaci√≥n</div>
    </div>

    <!-- Auth Container -->
    <div id="authContainer">
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-500 mb-4">
                <i class="fas fa-music text-white text-2xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê</h1>
            <p class="text-gray-400 text-sm">Tu reproductor de m√∫sica personal en la nube</p>
        </div>
        
        <div class="w-full max-w-md">
            <div class="flex mb-4">
                <div class="auth-tab active" id="loginTab">Iniciar Sesi√≥n</div>
                <div class="auth-tab" id="registerTab">Registrarse</div>
            </div>
            
            <div class="auth-form active" id="loginForm">
                <input type="email" class="auth-input" placeholder="Correo electr√≥nico" id="loginEmail">
                <input type="password" class="auth-input" placeholder="Contrase√±a" id="loginPassword">
                <button class="auth-button" id="loginButton">
                    <i class="fas fa-envelope mr-2"></i> Iniciar Sesi√≥n
                </button>
                
                <div class="divider">
                    <span>o</span>
                </div>
                
                <button class="auth-button" id="googleButton" style="background-color: #1DB954;">
                    <i class="fab fa-google mr-2"></i> Continuar con Google
                </button>
                
                <p class="text-center text-gray-400 text-sm mt-6">
                    Necesitas una cuenta para subir y guardar tus canciones
                </p>
            </div>
            
            <div class="auth-form" id="registerForm">
                <input type="email" class="auth-input" placeholder="Correo electr√≥nico" id="registerEmail">
                <input type="password" class="auth-input" placeholder="Contrase√±a" id="registerPassword">
                <input type="password" class="auth-input" placeholder="Confirmar Contrase√±a" id="confirmPassword">
                <button class="auth-button" id="registerButton">
                    <i class="fas fa-user-plus mr-2"></i> Crear Cuenta
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header id="appHeader" class="fixed top-0 left-0 right-0 bg-black bg-opacity-95 z-10 shadow-lg" style="display: none;">
        <div class="flex justify-between items-center p-4">
            <div class="flex items-center">
                <i class="fas fa-music text-green-500 text-xl mr-2"></i>
                <h1 class="text-xl font-bold text-white">ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê</h1>
            </div>
            <div>
                <button id="settingsBtn" class="text-gray-300 p-2">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="flex justify-around border-b border-gray-800">
            <button id="tabPlayer" class="py-3 px-4 tab-active flex-1 text-center">
                <i class="fas fa-play mr-1"></i> Reproductor
            </button>
            <button id="tabPlaylist" class="py-3 px-4 text-gray-400 flex-1 text-center">
                <i class="fas fa-list mr-1"></i> Biblioteca
            </button>
            <button id="tabEqualizer" class="py-3 px-4 text-gray-400 flex-1 text-center">
                <i class="fas fa-sliders-h mr-1"></i> Ecualizador
            </button>
        </div>
    </header>

    <!-- Spacer para evitar superposici√≥n con el header -->
    <div id="headerSpacer" class="header-spacer" style="display: none;"></div>

    <main id="mainApp" class="main-container px-4" style="display: none;">
        <!-- Player Tab -->
        <section id="playerSection" class="block">
            <div class="flex flex-col items-center">
                <!-- Album Art -->
                <div class="w-64 h-64 bg-gray-800 rounded-lg mb-6 flex items-center justify-center overflow-hidden shadow-xl" id="albumArt">
                    <i class="fas fa-music text-5xl text-gray-600"></i>
                </div>
                
                <!-- Song Info -->
                <div class="w-full text-center mb-6">
                    <h2 id="songTitle" class="text-xl font-semibold text-white truncate">Selecciona una canci√≥n</h2>
                    <p id="songArtist" class="text-gray-400 truncate">Artista</p>
                </div>
                
                <!-- Audio Visualizer -->
                <div class="visualizer-container w-full mb-4" id="visualizer">
                    <!-- Bars will be added dynamically -->
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full mb-2">
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="music-controls flex items-center justify-center w-full mt-6">
                    <button id="shuffleBtn" class="mx-3 text-gray-400 focus:outline-none">
                        <i class="fas fa-random text-lg"></i>
                    </button>
                    <button id="prevBtn" class="mx-3 text-white focus:outline-none">
                        <i class="fas fa-step-backward text-xl"></i>
                    </button>
                    <button id="playBtn" class="mx-4 bg-green-500 w-14 h-14 rounded-full flex items-center justify-center text-white focus:outline-none shadow-lg">
                        <i class="fas fa-play text-xl" id="playIcon"></i>
                    </button>
                    <button id="nextBtn" class="mx-3 text-white focus:outline-none">
                        <i class="fas fa-step-forward text-xl"></i>
                    </button>
                    <button id="repeatBtn" class="mx-3 text-gray-400 focus:outline-none">
                        <i class="fas fa-redo-alt text-lg"></i>
                    </button>
                </div>
                
                <!-- Volume Control -->
                <div class="flex items-center w-full mt-6">
                    <i class="fas fa-volume-down text-gray-400 mr-2"></i>
                    <input type="range" min="0" max="100" value="80" class="volume-slider" id="volumeSlider">
                    <i class="fas fa-volume-up text-gray-400 ml-2"></i>
                </div>
            </div>
        </section>
        
        <!-- Playlist Tab -->
        <section id="playlistSection" class="hidden mt-6">
            <div class="mb-6">
                <label class="custom-file-upload w-full">
                    <input type="file" id="fileInput" accept="audio/*" multiple>
                    <i class="fas fa-plus mr-2"></i> Agregar canciones
                </label>
            </div>
            
            <!-- Upload Progress -->
            <div id="uploadProgressContainer" class="mb-6" style="display: none;">
                <h3 class="text-white mb-2">Subiendo: <span id="uploadFileName">archivo.mp3</span></h3>
                <div class="upload-progress-container">
                    <div id="uploadProgressBar" class="upload-progress-bar"></div>
                </div>
                <p class="text-right text-xs text-gray-400 mt-1"><span id="uploadProgress">0</span>%</p>
            </div>
            
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="Buscar canciones..." class="w-full bg-gray-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div id="playlistContainer" class="space-y-2">
                <div class="text-center text-gray-500 py-10" id="emptyLibrary">
                    <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                    <p>Biblioteca anterior encontrada</p>
                    <p class="text-sm">Agrega tus archivos de m√∫sica nuevamente</p>
                </div>
                
                <div id="songsList" class="space-y-2">
                    <!-- Songs will be added here -->
                </div>
            </div>
        </section>
        
        <!-- Equalizer Tab -->
        <section id="equalizerSection" class="hidden mt-6">
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">Ecualizador</h3>
                <div class="eq-container">
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq60">
                        <span class="text-xs mt-2">60Hz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq170">
                        <span class="text-xs mt-2">170Hz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq310">
                        <span class="text-xs mt-2">310Hz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq600">
                        <span class="text-xs mt-2">600Hz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq1k">
                        <span class="text-xs mt-2">1kHz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq3k">
                        <span class="text-xs mt-2">3kHz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq6k">
                        <span class="text-xs mt-2">6kHz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq12k">
                        <span class="text-xs mt-2">12kHz</span>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Preajustes</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button class="bg-gray-800 py-2 px-3 rounded-lg text-white flex items-center justify-center">
                        <i class="fas fa-equals text-green-500 mr-2"></i> Plano
                    </button>
                    <button class="bg-gray-800 py-2 px-3 rounded-lg text-white flex items-center justify-center">
                        <i class="fas fa-guitar text-gray-400 mr-2"></i> Rock
                    </button>
                    <button class="bg-gray-800 py-2 px-3 rounded-lg text-white flex items-center justify-center">
                        <i class="fas fa-music text-green-500 mr-2"></i> Pop
                    </button>
                    <button class="bg-gray-800 py-2 px-3 rounded-lg text-white flex items-center justify-center">
                        <i class="fas fa-compact-disc text-gray-400 mr-2"></i> Jazz
                    </button>
                    <button class="bg-gray-800 py-2 px-3 rounded-lg text-white flex items-center justify-center">
                        <i class="fas fa-violin text-gray-400 mr-2"></i> Cl√°sica
                    </button>
                    <button class="bg-gray-800 py-2 px-3 rounded-lg text-white flex items-center justify-center">
                        <i class="fas fa-volume-up text-green-500 mr-2"></i> Bass Boost
                    </button>
                </div>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold mb-3">Efectos</h3>
                <div class="mb-4">
                    <div class="flex justify-between mb-2">
                        <span>Reverberaci√≥n</span>
                        <span id="reverbValue">0%</span>
                    </div>
                    <input type="range" min="0" max="100" value="0" class="volume-slider" id="reverbSlider">
                </div>
                
                <div>
                    <div class="flex justify-between mb-2">
                        <span>Velocidad</span>
                        <span id="speedValue">1.0x</span>
                    </div>
                    <input type="range" min="50" max="150" value="100" class="volume-slider" id="speedSlider">
                </div>
            </div>
        </section>
    </main>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-80 z-20 flex items-center justify-center" style="display: none;">
        <div class="bg-gray-900 rounded-lg p-5 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Configuraci√≥n</h3>
                <button id="closeSettingsBtn" class="text-gray-400">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-5">
                <div class="flex justify-between items-center mb-2">
                    <span>Tema Oscuro</span>
                    <label class="toggle-switch">
                        <input type="checkbox" checked id="darkModeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="mb-5">
                <p class="mb-2">Calidad de audio</p>
                <select class="w-full bg-gray-800 text-white p-3 rounded-lg">
                    <option>Alta (320kbps)</option>
                    <option>Media (192kbps)</option>
                    <option>Baja (128kbps)</option>
                </select>
            </div>
            
            <div class="mb-5">
                <p class="mb-3">Usuario</p>
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-gray-300"></i>
                    </div>
                    <div>
                        <p id="userEmail" class="text-white">usuario@ejemplo.com</p>
                        <p class="text-xs text-gray-400">Cuenta gratuita</p>
                    </div>
                </div>
                <button id="logoutBtn" class="text-red-500 flex items-center">
                    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar sesi√≥n
                </button>
            </div>
            
            <div>
                <p class="text-xs text-gray-500 text-center">Versi√≥n 1.0.0</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v9 (modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, onSnapshot, serverTimestamp, updateDoc, where } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        // Firebase configuration  
        const firebaseConfig = {
            apiKey: "AIzaSyCmFq5ISq59Ql84Ntf_QiynlQtMX31zmwo",
            authDomain: "fuck-musix.firebaseapp.com",
            projectId: "fuck-musix",
            storageBucket: "fuck-musix.firebasestorage.app",
            messagingSenderId: "858119028230",
            appId: "1:858119028230:web:63dc3168ac63221a82cd87",
            measurementId: "G-B3JK4M6STY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        // Configure Google provider
        provider.addScope('profile');
        provider.addScope('email');
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const appHeader = document.getElementById('appHeader');
        const headerSpacer = document.getElementById('headerSpacer');
        const mainApp = document.getElementById('mainApp');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const googleButton = document.getElementById('googleButton');
        const logoutBtn = document.getElementById('logoutBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const tabPlayer = document.getElementById('tabPlayer');
        const tabPlaylist = document.getElementById('tabPlaylist');
        const tabEqualizer = document.getElementById('tabEqualizer');
        const playerSection = document.getElementById('playerSection');
        const playlistSection = document.getElementById('playlistSection');
        const equalizerSection = document.getElementById('equalizerSection');
        const userEmailDisplay = document.getElementById('userEmail');
        const playlistContainer = document.getElementById('playlistContainer');
        const emptyLibrary = document.getElementById('emptyLibrary');
        const songsList = document.getElementById('songsList');
        const fileInput = document.getElementById('fileInput');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const repeatBtn = document.getElementById('repeatBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const currentTimeDisplay = document.getElementById('currentTime');
        const totalTimeDisplay = document.getElementById('totalTime');
        const volumeSlider = document.getElementById('volumeSlider');
        const songTitle = document.getElementById('songTitle');
        const songArtist = document.getElementById('songArtist');
        const visualizer = document.getElementById('visualizer');
        const reverbSlider = document.getElementById('reverbSlider');
        const speedSlider = document.getElementById('speedSlider');
        const reverbValue = document.getElementById('reverbValue');
        const speedValue = document.getElementById('speedValue');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingTitle = document.getElementById('loadingTitle');
        const loadingMessage = document.getElementById('loadingMessage');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        const uploadProgressContainer = document.getElementById('uploadProgressContainer');
        const uploadFileName = document.getElementById('uploadFileName');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadProgress = document.getElementById('uploadProgress');

        // App State
        let currentUser = null;
        let currentAudio = null;
        let tracks = [];
        let currentTrackIndex = -1;
        let isPlaying = false;
        let isShuffled = false;
        let isLooped = false;
        let visualizerBars = [];
        let visualizerAnimationId = null;

        // Auth state change
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('Usuario autenticado:', user.displayName || user.email);
                currentUser = user;
                userEmailDisplay.textContent = user.email || 'Usuario';
                
                // Show app, hide auth
                authContainer.style.display = 'none';
                appHeader.style.display = 'block';
                headerSpacer.style.display = 'block';
                mainApp.style.display = 'block';
                
                // Load user data
                loadUserTracks();
            } else {
                console.log('Usuario no autenticado');
                currentUser = null;
                
                // Show auth, hide app
                authContainer.style.display = 'flex';
                appHeader.style.display = 'none';
                headerSpacer.style.display = 'none';
                mainApp.style.display = 'none';
                
                // Stop any playing audio
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
            }
        });

        // Auth tabs
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginForm.classList.add('active');
            registerForm.classList.remove('active');
        });

        registerTab.addEventListener('click', () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerForm.classList.add('active');
            loginForm.classList.remove('active');
        });

        // Login
        loginButton.addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('Por favor complete todos los campos', 'error');
                return;
            }
            
            showLoading('Iniciando sesi√≥n', 'Verificando credenciales...');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideLoading();
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error);
                hideLoading();
                showNotification('Error al iniciar sesi√≥n: ' + error.message, 'error');
            }
        });

        // Register
        registerButton.addEventListener('click', async () => {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!email || !password || !confirmPassword) {
                showNotification('Por favor complete todos los campos', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Las contrase√±as no coinciden', 'error');
                return;
            }
            
            showLoading('Registrando cuenta', 'Creando nueva cuenta...');
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                hideLoading();
                showNotification('Cuenta creada exitosamente', 'success');
            } catch (error) {
                console.error('Error al registrarse:', error);
                hideLoading();
                showNotification('Error al registrarse: ' + error.message, 'error');
            }
        });

        // Google Auth
        googleButton.addEventListener('click', async () => {
            showLoading('Iniciando sesi√≥n con Google', 'Redirigiendo...');
            
            try {
                await signInWithPopup(auth, provider);
                hideLoading();
            } catch (error) {
                console.error('Error al iniciar sesi√≥n con Google:', error);
                hideLoading();
                showNotification('Error al iniciar sesi√≥n con Google: ' + error.message, 'error');
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            showLoading('Cerrando sesi√≥n', 'Finalizando sesi√≥n...');
            
            try {
                await signOut(auth);
                settingsModal.style.display = 'none';
                hideLoading();
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
                hideLoading();
                showNotification('Error al cerrar sesi√≥n: ' + error.message, 'error');
            }
        });

        // App tabs
        tabPlayer.addEventListener('click', () => {
            tabPlayer.classList.add('tab-active');
            tabPlaylist.classList.remove('tab-active');
            tabEqualizer.classList.remove('tab-active');
            
            playerSection.style.display = 'block';
            playlistSection.style.display = 'none';
            equalizerSection.style.display = 'none';
        });

        tabPlaylist.addEventListener('click', () => {
            tabPlaylist.classList.add('tab-active');
            tabPlayer.classList.remove('tab-active');
            tabEqualizer.classList.remove('tab-active');
            
            playlistSection.style.display = 'block';
            playerSection.style.display = 'none';
            equalizerSection.style.display = 'none';
        });

        tabEqualizer.addEventListener('click', () => {
            tabEqualizer.classList.add('tab-active');
            tabPlayer.classList.remove('tab-active');
            tabPlaylist.classList.remove('tab-active');
            
            equalizerSection.style.display = 'block';
            playerSection.style.display = 'none';
            playlistSection.style.display = 'none';
        });

        // Settings modal
        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        // Effect sliders
        reverbSlider.addEventListener('input', (e) => {
            reverbValue.textContent = `${e.target.value}%`;
        });

        speedSlider.addEventListener('input', (e) => {
            const value = e.target.value / 100;
            speedValue.textContent = `${value.toFixed(1)}x`;
            
            if (currentAudio) {
                currentAudio.playbackRate = value;
            }
        });

        // Loading overlay
        function showLoading(title, message) {
            loadingTitle.textContent = title;
            loadingMessage.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Notifications
        function showNotification(message, type = 'default') {
            notificationMessage.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'success') {
                notification.classList.add('success');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Create visualizer bars
        function createVisualizer() {
            visualizer.innerHTML = '';
            visualizerBars = [];
            
            for (let i = 0; i < 30; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                visualizer.appendChild(bar);
                visualizerBars.push(bar);
            }
        }

        // Animate visualizer
        function animateVisualizer() {
            if (!isPlaying) return;
            
            visualizerBars.forEach(bar => {
                const height = Math.random() * 30 + 5;
                bar.style.height = `${height}px`;
            });
            
            visualizerAnimationId = requestAnimationFrame(animateVisualizer);
        }

        // Stop visualizer animation
        function stopVisualizerAnimation() {
            if (visualizerAnimationId) {
                cancelAnimationFrame(visualizerAnimationId);
                visualizerAnimationId = null;
            }
            
            visualizerBars.forEach(bar => {
                bar.style.height = '5px';
            });
        }

        // Format time (seconds to MM:SS)
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Extract metadata from filename
        function extractMetadata(filename) {
            const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
            const parts = nameWithoutExt.split(' - ');
            
            if (parts.length >= 2) {
                return {
                    artist: parts[0].trim(),
                    title: parts.slice(1).join(' - ').trim()
                };
            }
            
            return {
                artist: 'Artista Desconocido',
                title: nameWithoutExt.trim()
            };
        }

        // Load user tracks
        async function loadUserTracks() {
            if (!currentUser) return;
            
            showLoading('Cargando biblioteca', 'Obteniendo tus canciones...');
            
            try {
                const tracksRef = collection(db, 'tracks');
                const q = query(
                    tracksRef, 
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                
                const snapshot = await getDocs(q);
                tracks = [];
                
                snapshot.forEach(doc => {
                    tracks.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log('Tracks loaded:', tracks.length);
                
                // Log some track data to verify the URLs are present
                if (tracks.length > 0) {
                    console.log('Sample track data:', tracks[0]);
                }
                
                updatePlaylistView();
                hideLoading();
            } catch (error) {
                console.error('Error loading tracks:', error);
                hideLoading();
                showNotification('Error al cargar las canciones: ' + error.message, 'error');
            }
        }

        // Update playlist view
        function updatePlaylistView() {
            if (tracks.length === 0) {
                emptyLibrary.style.display = 'block';
                songsList.style.display = 'none';
                return;
            }
            
            emptyLibrary.style.display = 'none';
            songsList.style.display = 'block';
            songsList.innerHTML = '';
            
            tracks.forEach((track, index) => {
                const trackItem = document.createElement('div');
                trackItem.className = 'playlist-item bg-gray-800 rounded-lg p-3 flex items-center justify-between';
                trackItem.innerHTML = `
                    <div class="overflow-hidden">
                        <h4 class="font-medium text-white truncate">${track.title || 'Sin t√≠tulo'}</h4>
                        <p class="text-sm text-gray-400 truncate">${track.artist || 'Desconocido'}</p>
                    </div>
                    <div class="flex items-center">
                        <button class="play-track-btn w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                `;
                
                songsList.appendChild(trackItem);
                
                // Play button event
                trackItem.querySelector('.play-track-btn').addEventListener('click', () => {
                    playTrack(index);
                });
            });
        }

        // Play a track
        function playTrack(index) {
            if (index < 0 || index >= tracks.length) return;
            
            currentTrackIndex = index;
            const track = tracks[index];
            
            console.log('Playing track:', track);
            
            // Update UI
            songTitle.textContent = track.title || 'Sin t√≠tulo';
            songArtist.textContent = track.artist || 'Desconocido';
            
            // Create or update audio element
            if (!currentAudio) {
                currentAudio = new Audio();
                
                // Set up audio events
                currentAudio.addEventListener('timeupdate', updateProgress);
                currentAudio.addEventListener('loadedmetadata', () => {
                    totalTimeDisplay.textContent = formatTime(currentAudio.duration);
                });
                currentAudio.addEventListener('ended', () => {
                    if (isLooped) {
                        currentAudio.currentTime = 0;
                        currentAudio.play();
                    } else {
                        playNextTrack();
                    }
                });
                
                // Add error handling
                currentAudio.addEventListener('error', (e) => {
                    console.error('Audio error:', e);
                    showNotification('Error al reproducir el audio: ' + (e.message || 'Error desconocido'), 'error');
                });
            }
            
            // Set audio source - make sure we have a valid URL
            if (!track.url) {
                showNotification('Esta canci√≥n no tiene una URL v√°lida', 'error');
                return;
            }
            
            console.log('Setting audio source to:', track.url);
            currentAudio.src = track.url;
            currentAudio.volume = volumeSlider.value / 100;
            currentAudio.playbackRate = speedSlider.value / 100;
            
            // Play the audio
            const playPromise = currentAudio.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log('Audio playing successfully');
                        isPlaying = true;
                        playIcon.className = 'fas fa-pause text-xl';
                        
                        // Switch to player tab
                        tabPlayer.click();
                        
                        // Start visualizer
                        createVisualizer();
                        animateVisualizer();
                    })
                    .catch(error => {
                        console.error('Error playing audio:', error);
                        showNotification('Error al reproducir: ' + error.message, 'error');
                    });
            }
        }

        // Update progress bar
        function updateProgress() {
            if (!currentAudio) return;
            
            const currentTime = currentAudio.currentTime;
            const duration = currentAudio.duration;
            
            if (isNaN(duration)) return;
            
            // Update time display
            currentTimeDisplay.textContent = formatTime(currentTime);
            
            // Update progress bar
            const progressPercent = (currentTime / duration) * 100;
            progressBar.style.width = `${progressPercent}%`;
        }

        // Play/Pause toggle
        playBtn.addEventListener('click', () => {
            if (!currentAudio || !currentAudio.src) {
                if (tracks.length > 0) {
                    playTrack(0);
                }
                return;
            }
            
            if (isPlaying) {
                currentAudio.pause();
                isPlaying = false;
                playIcon.className = 'fas fa-play text-xl';
                stopVisualizerAnimation();
            } else {
                currentAudio.play()
                    .then(() => {
                        isPlaying = true;
                        playIcon.className = 'fas fa-pause text-xl';
                        animateVisualizer();
                    })
                    .catch(error => {
                        console.error('Error playing audio:', error);
                        showNotification('Error al reproducir: ' + error.message, 'error');
                    });
            }
        });

        // Progress bar seeking
        progressContainer.addEventListener('click', (e) => {
            if (!currentAudio) return;
            
            const width = progressContainer.clientWidth;
            const clickX = e.offsetX;
            const duration = currentAudio.duration;
            
            if (isNaN(duration)) return;
            
            currentAudio.currentTime = (clickX / width) * duration;
        });

        // Volume control
        volumeSlider.addEventListener('input', () => {
            if (currentAudio) {
                currentAudio.volume = volumeSlider.value / 100;
            }
        });

        // Play next track
        function playNextTrack() {
            if (tracks.length === 0) return;
            
            let nextIndex;
            
            if (isShuffled) {
                nextIndex = Math.floor(Math.random() * tracks.length);
            } else {
                nextIndex = (currentTrackIndex + 1) % tracks.length;
            }
            
            playTrack(nextIndex);
        }

        // Play previous track
        function playPrevTrack() {
            if (tracks.length === 0) return;
            
            let prevIndex;
            
            if (isShuffled) {
                prevIndex = Math.floor(Math.random() * tracks.length);
            } else {
                prevIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
            }
            
            playTrack(prevIndex);
        }

        // Next button
        nextBtn.addEventListener('click', () => {
            playNextTrack();
        });

        // Previous button
        prevBtn.addEventListener('click', () => {
            // If current time > 3 seconds, restart song, otherwise go to previous
            if (currentAudio && currentAudio.currentTime > 3) {
                currentAudio.currentTime = 0;
            } else {
                playPrevTrack();
            }
        });

        // Shuffle button
        shuffleBtn.addEventListener('click', () => {
            isShuffled = !isShuffled;
            shuffleBtn.style.color = isShuffled ? '#1DB954' : '#9CA3AF';
        });

        // Repeat button
        repeatBtn.addEventListener('click', () => {
            isLooped = !isLooped;
            repeatBtn.style.color = isLooped ? '#1DB954' : '#9CA3AF';
        });

        // Cloudinary Uploader
        class CloudinaryUploader {
            constructor() {
                this.cloudName = 'dgy5bftjt';
                this.uploadPreset = 'mp3_unsigned';
                this.apiUrl = `https://api.cloudinary.com/v1_1/${this.cloudName}/auto/upload`;
            }
            
            async uploadFile(file, progressCallback) {
                return new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', this.uploadPreset);
                    
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', this.apiUrl, true);
                    
                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable && progressCallback) {
                            const progress = Math.round((e.loaded / e.total) * 100);
                            progressCallback(progress);
                        }
                    };
                    
                    xhr.onload = function() {
                        if (this.status >= 200 && this.status < 300) {
                            const response = JSON.parse(this.response);
                            console.log('Cloudinary response:', response);
                            resolve(response);
                        } else {
                            reject(new Error('Error uploading to Cloudinary: ' + this.statusText));
                        }
                    };
                    
                    xhr.onerror = function() {
                        reject(new Error('XHR Error'));
                    };
                    
                    xhr.send(formData);
                });
            }
        }
        
        const cloudinaryUploader = new CloudinaryUploader();

        // File upload
        fileInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            if (!currentUser) {
                showNotification('Debes iniciar sesi√≥n para subir archivos', 'error');
                return;
            }
            
            // Process each file
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validate file is audio
                if (!file.type.startsWith('audio/')) {
                    showNotification(`${file.name} no es un archivo de audio v√°lido`, 'error');
                    continue;
                }
                
                // Extract metadata
                const { artist, title } = extractMetadata(file.name);
                
                // Show upload progress
                uploadFileName.textContent = file.name;
                uploadProgressContainer.style.display = 'block';
                uploadProgressBar.style.width = '0%';
                uploadProgress.textContent = '0';
                
                try {
                    // Upload to Cloudinary
                    const result = await cloudinaryUploader.uploadFile(file, (progress) => {
                        uploadProgressBar.style.width = `${progress}%`;
                        uploadProgress.textContent = progress;
                    });
                    
                    console.log('Cloudinary upload result:', result);
                    
                    // Make sure we have a secure_url
                    if (!result.secure_url) {
                        throw new Error('No se obtuvo una URL de Cloudinary');
                    }
                    
                    // Create temporary audio to get duration
                    const audio = new Audio();
                    audio.src = result.secure_url;
                    
                    let duration = 0;
                    try {
                        await new Promise((resolve, reject) => {
                            audio.addEventListener('loadedmetadata', () => {
                                duration = audio.duration;
                                resolve();
                            });
                            
                            // Handle error case
                            audio.addEventListener('error', (e) => {
                                console.warn('Error getting duration:', e);
                                resolve(); // Continue anyway
                            });
                            
                            // Set a timeout in case the audio never loads
                            setTimeout(resolve, 5000);
                        });
                    } catch (err) {
                        console.warn('Could not get duration:', err);
                    }
                    
                    // Add to Firestore with the correct URL field
                    const trackData = {
                        title,
                        artist,
                        url: result.secure_url,
                        duration: duration || 0,
                        userId: currentUser.uid,
                        playlist: 'default',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    
                    console.log('Adding track to Firestore:', trackData);
                    
                    const docRef = await addDoc(collection(db, 'tracks'), trackData);
                    console.log('Track added with ID:', docRef.id);
                    
                    showNotification(`${title} se ha subido correctamente`, 'success');
                } catch (error) {
                    console.error('Error uploading file:', error);
                    showNotification(`Error al subir ${file.name}: ${error.message}`, 'error');
                }
            }
            
            // Hide upload progress and reset file input
            uploadProgressContainer.style.display = 'none';
            fileInput.value = null;
            
            // Reload tracks
            await loadUserTracks();
        });

        // Initialize visualizer
        createVisualizer();
    </script>
</body>
</html>
