<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê - Mobile Debug Version</title>
    
    <!-- Bootstrap CSS with Replit theme -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Mobile-First Styles -->
    <style>
        /* Mobile-first optimizations */
        body {
            touch-action: manipulation;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: contain;
        }

        /* Debug Console Styles */
        .debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(13, 17, 23, 0.95);
            border-top: 2px solid var(--bs-primary);
            max-height: 40vh;
            overflow-y: auto;
            z-index: 9999;
            backdrop-filter: blur(10px);
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .debug-console.show {
            transform: translateY(0);
        }

        .debug-console-header {
            background: var(--bs-dark);
            padding: 8px 16px;
            border-bottom: 1px solid var(--bs-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-log {
            padding: 8px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .debug-entry {
            margin-bottom: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid var(--bs-info);
        }

        .debug-error {
            border-left-color: var(--bs-danger);
            background: rgba(220, 53, 69, 0.1);
        }

        .debug-warning {
            border-left-color: var(--bs-warning);
            background: rgba(255, 193, 7, 0.1);
        }

        .debug-success {
            border-left-color: var(--bs-success);
            background: rgba(25, 135, 84, 0.1);
        }

        /* Floating Debug Toggle */
        .debug-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bs-primary);
            border: none;
            color: white;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            touch-action: manipulation;
        }

        /* Upload Progress Overlay */
        .upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 9998;
            backdrop-filter: blur(5px);
        }

        .upload-progress {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bs-dark);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--bs-primary);
            text-align: center;
            min-width: 300px;
        }

        /* Mobile Touch Optimizations */
        .btn {
            min-height: 44px;
            min-width: 44px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            border: 2px dashed var(--bs-border-color);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            touch-action: manipulation;
        }

        .file-input-wrapper:hover,
        .file-input-wrapper.dragover {
            border-color: var(--bs-primary);
            background: rgba(13, 110, 253, 0.1);
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        /* Track List Mobile Optimization */
        .track-item {
            border: 1px solid var(--bs-border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--bs-dark);
        }

        .track-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
        }

        .mobile-toast {
            min-width: 300px;
            max-width: calc(100vw - 40px);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }
            
            .debug-console {
                max-height: 50vh;
            }
            
            .upload-progress {
                min-width: calc(100vw - 40px);
                margin: 20px;
            }
        }

        /* Connection Status Indicator */
        .connection-status {
            position: fixed;
            top: 80px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 9999;
        }

        .connection-online {
            background: var(--bs-success);
            color: white;
        }

        .connection-offline {
            background: var(--bs-danger);
            color: white;
        }

        .connection-slow {
            background: var(--bs-warning);
            color: black;
        }
    </style>
</head>

<body data-bs-theme="dark">
    <!-- Debug Toggle Button -->
    <button class="debug-toggle" onclick="toggleDebugConsole()" title="Toggle Debug Console">
        <i class="fas fa-bug"></i>
    </button>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connection-online">
        <i class="fas fa-wifi"></i> Online
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <!-- Toasts will be inserted here -->
    </div>

    <!-- Upload Progress Overlay -->
    <div id="uploadOverlay" class="upload-overlay">
        <div class="upload-progress">
            <div id="uploadSpinner" class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Uploading...</span>
            </div>
            <h5 id="uploadTitle">Subiendo archivo...</h5>
            <div class="progress mb-3">
                <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
            <p id="uploadStatus" class="text-muted mb-0">Preparando...</p>
            <button id="uploadCancel" class="btn btn-outline-danger btn-sm mt-3" onclick="cancelUpload()">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Authentication Section -->
    <div id="authSection" class="container-fluid d-flex align-items-center justify-content-center vh-100">
        <div class="card" style="max-width: 400px; width: 100%;">
            <div class="card-body text-center">
                <h2 class="card-title mb-4">ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê</h2>
                <p class="text-muted mb-4">Inicia sesi√≥n para continuar</p>
                
                <!-- Google Sign In -->
                <button id="googleSignInBtn" class="btn btn-primary w-100 mb-3">
                    <i class="fab fa-google me-2"></i>
                    Continuar con Google
                </button>
                
                <hr>
                
                <!-- Email Sign In Form -->
                <form id="emailSignInForm" class="mb-3">
                    <div class="mb-3">
                        <input type="email" id="emailInput" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="mb-3">
                        <input type="password" id="passwordInput" class="form-control" placeholder="Contrase√±a" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-outline-primary">Iniciar Sesi√≥n</button>
                        <button type="button" id="signUpBtn" class="btn btn-outline-secondary">Crear Cuenta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container-fluid py-4" style="display: none;">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê</h1>
            <div class="d-flex align-items-center gap-3">
                <span id="userInfo" class="text-muted"></span>
                <button id="signOutBtn" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Subir M√∫sica
                </h5>
            </div>
            <div class="card-body">
                <div class="file-input-wrapper" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" multiple accept=".mp3,.m4a" onchange="handleFileSelect(event)">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h6>Toca para seleccionar archivos</h6>
                    <p class="text-muted mb-0">MP3 y M4A - M√°ximo 50MB por archivo</p>
                </div>
                
                <div id="selectedFiles" class="mt-3" style="display: none;">
                    <h6>Archivos seleccionados:</h6>
                    <div id="filesList"></div>
                    <button id="uploadBtn" class="btn btn-primary mt-3">
                        <i class="fas fa-upload me-2"></i>
                        Subir Archivos
                    </button>
                </div>
            </div>
        </div>

        <!-- Tracks List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-music me-2"></i>
                    Mi M√∫sica
                </h5>
                <button id="refreshBtn" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="tracksList">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-music fa-3x mb-3 opacity-50"></i>
                        <p>No hay m√∫sica subida a√∫n</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Console -->
    <div id="debugConsole" class="debug-console">
        <div class="debug-console-header">
            <span><i class="fas fa-terminal me-2"></i>Debug Console</span>
            <div>
                <button class="btn btn-outline-light btn-sm me-2" onclick="clearDebugLog()">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="toggleDebugConsole()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div id="debugLog" class="debug-log">
            <!-- Debug entries will be added here -->
        </div>
    </div>

    <!-- Firebase SDK and Application Logic -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        // Mobile Debug Logger Class
        class MobileDebugLogger {
            constructor() {
                this.logs = [];
                this.maxLogs = 100;
                this.isVisible = false;
                this.initializeLogger();
                this.setupNetworkMonitoring();
                this.setupErrorHandling();
            }

            initializeLogger() {
                // Load previous logs from localStorage
                const savedLogs = localStorage.getItem('debug-logs');
                if (savedLogs) {
                    try {
                        this.logs = JSON.parse(savedLogs).slice(-this.maxLogs);
                        this.renderLogs();
                    } catch (e) {
                        console.error('Error loading saved logs:', e);
                    }
                }

                this.log('info', 'Debug system initialized', 'Mobile debugging ready');
                this.log('info', 'User Agent', navigator.userAgent);
                this.log('info', 'Viewport', `${window.innerWidth}x${window.innerHeight}`);
                this.log('info', 'Connection', navigator.onLine ? 'Online' : 'Offline');
                
                // Log device capabilities
                if ('deviceMemory' in navigator) {
                    this.log('info', 'Device Memory', `${navigator.deviceMemory} GB`);
                }
                
                if ('connection' in navigator) {
                    const connection = navigator.connection;
                    this.log('info', 'Connection Type', connection.effectiveType || 'unknown');
                    this.log('info', 'Downlink', `${connection.downlink || 'unknown'} Mbps`);
                }
            }

            setupNetworkMonitoring() {
                // Monitor online/offline status
                window.addEventListener('online', () => {
                    this.log('success', 'Network', 'Connection restored');
                    this.updateConnectionStatus('online');
                });

                window.addEventListener('offline', () => {
                    this.log('error', 'Network', 'Connection lost');
                    this.updateConnectionStatus('offline');
                });

                // Monitor connection speed
                if ('connection' in navigator) {
                    const connection = navigator.connection;
                    
                    connection.addEventListener('change', () => {
                        this.log('info', 'Connection Change', 
                            `Type: ${connection.effectiveType}, Downlink: ${connection.downlink} Mbps`);
                        
                        if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                            this.updateConnectionStatus('slow');
                        } else {
                            this.updateConnectionStatus('online');
                        }
                    });
                }
            }

            setupErrorHandling() {
                // Capture unhandled errors
                window.addEventListener('error', (event) => {
                    this.log('error', 'JavaScript Error', 
                        `${event.error?.message || event.message} at ${event.filename}:${event.lineno}`);
                });

                // Capture unhandled promise rejections
                window.addEventListener('unhandledrejection', (event) => {
                    this.log('error', 'Unhandled Promise Rejection', event.reason?.toString() || 'Unknown error');
                });
            }

            log(type, category, message, data = null) {
                const timestamp = new Date().toISOString().split('T')[1].substring(0, 8);
                const logEntry = {
                    timestamp,
                    type,
                    category,
                    message,
                    data
                };

                this.logs.push(logEntry);
                
                // Keep only latest logs
                if (this.logs.length > this.maxLogs) {
                    this.logs = this.logs.slice(-this.maxLogs);
                }

                // Save to localStorage
                try {
                    localStorage.setItem('debug-logs', JSON.stringify(this.logs));
                } catch (e) {
                    console.warn('Could not save logs to localStorage:', e);
                }

                // Render if console is visible
                if (this.isVisible) {
                    this.renderLogs();
                }

                // Also log to browser console with additional context
                const contextualMessage = `[${category}] ${message}`;
                switch (type) {
                    case 'error':
                        console.error(contextualMessage, data);
                        break;
                    case 'warning':
                        console.warn(contextualMessage, data);
                        break;
                    case 'success':
                        console.log(`‚úÖ ${contextualMessage}`, data);
                        break;
                    default:
                        console.log(contextualMessage, data);
                }
            }

            renderLogs() {
                const debugLog = document.getElementById('debugLog');
                if (!debugLog) return;

                debugLog.innerHTML = this.logs.map(log => {
                    let dataStr = '';
                    if (log.data) {
                        if (typeof log.data === 'object') {
                            try {
                                dataStr = `<br><small>${JSON.stringify(log.data, null, 2)}</small>`;
                            } catch (e) {
                                dataStr = `<br><small>${log.data.toString()}</small>`;
                            }
                        } else {
                            dataStr = `<br><small>${log.data}</small>`;
                        }
                    }

                    return `
                        <div class="debug-entry debug-${log.type}">
                            <strong>${log.timestamp}</strong> [${log.category}] ${log.message}${dataStr}
                        </div>
                    `;
                }).join('');

                // Auto-scroll to bottom
                debugLog.scrollTop = debugLog.scrollHeight;
            }

            updateConnectionStatus(status) {
                const statusEl = document.getElementById('connectionStatus');
                if (!statusEl) return;

                statusEl.className = `connection-status connection-${status}`;
                
                switch (status) {
                    case 'online':
                        statusEl.innerHTML = '<i class="fas fa-wifi"></i> Online';
                        break;
                    case 'offline':
                        statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                        break;
                    case 'slow':
                        statusEl.innerHTML = '<i class="fas fa-signal"></i> Slow';
                        break;
                }
            }

            clear() {
                this.logs = [];
                localStorage.removeItem('debug-logs');
                this.renderLogs();
            }

            toggle() {
                this.isVisible = !this.isVisible;
                const console = document.getElementById('debugConsole');
                if (console) {
                    console.classList.toggle('show', this.isVisible);
                    if (this.isVisible) {
                        this.renderLogs();
                    }
                }
            }
        }

        // Enhanced Cloudinary Uploader with Mobile Debugging
        class CloudinaryUploader {
            constructor(logger) {
                this.cloudName = 'dgy5bftjt';
                this.uploadPreset = 'mp3_unsigned';
                this.apiUrl = `https://api.cloudinary.com/v1_1/${this.cloudName}/auto/upload`;
                this.logger = logger;
                this.activeUploads = new Map();
                
                this.logger.log('info', 'Cloudinary', 'Uploader initialized', {
                    cloudName: this.cloudName,
                    uploadPreset: this.uploadPreset,
                    apiUrl: this.apiUrl
                });
            }

            async uploadFile(file, onProgress = null) {
                const uploadId = Date.now() + Math.random();
                this.logger.log('info', 'Upload Start', `Starting upload for ${file.name}`, {
                    fileName: file.name,
                    fileSize: `${(file.size / 1024 / 1024).toFixed(2)} MB`,
                    fileType: file.type,
                    uploadId
                });

                return new Promise((resolve, reject) => {
                    // Comprehensive file validation
                    if (!this.isValidAudioFile(file)) {
                        const error = `Invalid file type: ${file.type}. Only MP3 and M4A files are allowed.`;
                        this.logger.log('error', 'Upload Validation', error, {
                            fileName: file.name,
                            fileType: file.type,
                            uploadId
                        });
                        reject(new Error(error));
                        return;
                    }

                    const maxSize = 50 * 1024 * 1024; // 50MB
                    if (file.size > maxSize) {
                        const error = `File too large: ${(file.size / 1024 / 1024).toFixed(2)} MB. Maximum allowed: 50MB`;
                        this.logger.log('error', 'Upload Validation', error, {
                            fileName: file.name,
                            fileSize: file.size,
                            maxSize,
                            uploadId
                        });
                        reject(new Error(error));
                        return;
                    }

                    // Check network connection
                    if (!navigator.onLine) {
                        const error = 'No internet connection detected';
                        this.logger.log('error', 'Upload Network', error, { uploadId });
                        reject(new Error(error));
                        return;
                    }

                    // Prepare FormData with additional debugging
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', this.uploadPreset);
                    formData.append('resource_type', 'video'); // Cloudinary treats audio as video
                    
                    // Add mobile-specific parameters
                    formData.append('quality', 'auto');
                    formData.append('flags', 'progressive');
                    
                    this.logger.log('info', 'Upload Prepare', 'FormData prepared', {
                        uploadPreset: this.uploadPreset,
                        resourceType: 'video',
                        uploadId
                    });

                    const xhr = new XMLHttpRequest();
                    this.activeUploads.set(uploadId, xhr);

                    // Enhanced progress tracking
                    if (onProgress) {
                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const percentComplete = (e.loaded / e.total) * 100;
                                const mbLoaded = (e.loaded / 1024 / 1024).toFixed(2);
                                const mbTotal = (e.total / 1024 / 1024).toFixed(2);
                                
                                this.logger.log('info', 'Upload Progress', 
                                    `${percentComplete.toFixed(1)}% (${mbLoaded}/${mbTotal} MB)`, {
                                    uploadId,
                                    loaded: e.loaded,
                                    total: e.total,
                                    percent: percentComplete
                                });
                                
                                onProgress(percentComplete);
                            }
                        });
                    }

                    // Enhanced success handling
                    xhr.addEventListener('load', () => {
                        this.activeUploads.delete(uploadId);
                        
                        this.debugger.log('info', 'Upload Response', 
                            `Server responded with status ${xhr.status}`, {
                            uploadId,
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseLength: xhr.responseText?.length || 0
                        });
                        
                        if (xhr.status === 200) {
                            try {
                                const result = JSON.parse(xhr.responseText);
                                this.debugger.log('success', 'Upload Complete', 
                                    `Successfully uploaded ${file.name}`, {
                                    uploadId,
                                    cloudinaryId: result.public_id,
                                    secureUrl: result.secure_url,
                                    format: result.format,
                                    bytes: result.bytes
                                });
                                resolve(result);
                            } catch (error) {
                                this.debugger.log('error', 'Upload Parse', 
                                    'Failed to parse server response', {
                                    uploadId,
                                    error: error.message,
                                    response: xhr.responseText?.substring(0, 200)
                                });
                                reject(new Error('Error parsing server response'));
                            }
                        } else {
                            this.debugger.log('error', 'Upload Server Error', 
                                `Server error ${xhr.status}`, {
                                uploadId,
                                status: xhr.status,
                                statusText: xhr.statusText,
                                response: xhr.responseText?.substring(0, 200)
                            });
                            reject(new Error(`Upload failed: ${xhr.status} ${xhr.statusText}`));
                        }
                    });

                    // Enhanced error handling
                    xhr.addEventListener('error', () => {
                        this.activeUploads.delete(uploadId);
                        this.debugger.log('error', 'Upload Network Error', 
                            'Network error during upload', {
                            uploadId,
                            readyState: xhr.readyState,
                            status: xhr.status
                        });
                        reject(new Error('Network error during upload'));
                    });

                    // Timeout handling
                    xhr.addEventListener('timeout', () => {
                        this.activeUploads.delete(uploadId);
                        this.debugger.log('error', 'Upload Timeout', 
                            'Upload timed out', {
                            uploadId,
                            timeout: xhr.timeout
                        });
                        reject(new Error('Upload timed out'));
                    });

                    // Abort handling
                    xhr.addEventListener('abort', () => {
                        this.activeUploads.delete(uploadId);
                        this.debugger.log('warning', 'Upload Abort', 
                            'Upload was cancelled', { uploadId });
                        reject(new Error('Upload was cancelled'));
                    });

                    // Configure and send request
                    xhr.timeout = 5 * 60 * 1000; // 5 minutes
                    xhr.open('POST', this.apiUrl);
                    
                    // Set mobile-friendly headers
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    
                    this.debugger.log('info', 'Upload Send', 'Sending upload request', {
                        uploadId,
                        url: this.apiUrl,
                        timeout: xhr.timeout
                    });
                    
                    xhr.send(formData);
                });
            }

            isValidAudioFile(file) {
                const validTypes = [
                    'audio/mpeg',
                    'audio/mp3',
                    'audio/mp4',
                    'audio/x-m4a',
                    'audio/aac',
                    'audio/mp4a-latm',
                    'audio/x-mp3'
                ];

                const validExtensions = ['.mp3', '.m4a', '.aac'];
                const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));

                const isValidType = validTypes.includes(file.type);
                const isValidExtension = validExtensions.includes(fileExtension);

                this.debugger.log('info', 'File Validation', 'Checking file validity', {
                    fileName: file.name,
                    fileType: file.type,
                    fileExtension,
                    isValidType,
                    isValidExtension,
                    result: isValidType || isValidExtension
                });

                return isValidType || isValidExtension;
            }

            cancelAllUploads() {
                this.debugger.log('warning', 'Upload Cancel', `Cancelling ${this.activeUploads.size} active uploads`);
                
                for (const [uploadId, xhr] of this.activeUploads) {
                    xhr.abort();
                    this.debugger.log('info', 'Upload Cancel', `Cancelled upload ${uploadId}`);
                }
                
                this.activeUploads.clear();
            }

            extractMetadata(filename) {
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
                const parts = nameWithoutExt.split(' - ');
                
                if (parts.length >= 2) {
                    return {
                        artist: parts[0].trim(),
                        title: parts.slice(1).join(' - ').trim()
                    };
                }
                
                return {
                    artist: 'Artista Desconocido',
                    title: nameWithoutExt.trim()
                };
            }
        }

        // Firebase Service with Enhanced Debugging
        class FirebaseService {
            constructor(logger) {
                this.logger = logger;
                this.currentUser = null;
                this.tracksCollection = null;
                this.initializeFirebase();
            }

            initializeFirebase() {
                // Firebase configuration - using real data from user
                const firebaseConfig = {
                    apiKey: "AIzaSyCmFq5ISq59Ql84Ntf_QiynlQtMX31zmwo",
                    authDomain: "fuck-musix.firebaseapp.com",
                    projectId: "fuck-musix",
                    storageBucket: "fuck-musix.firebasestorage.app",
                    messagingSenderId: "858119028230",
                    appId: "1:858119028230:web:63dc3168ac63221a82cd87",
                    measurementId: "G-B3JK4M6STY"
                };

                this.logger.log('info', 'Firebase', 'Initializing Firebase', firebaseConfig);

                try {
                    this.app = initializeApp(firebaseConfig);
                    this.db = getFirestore(this.app);
                    this.auth = getAuth(this.app);
                    this.provider = new GoogleAuthProvider();
                    
                    this.tracksCollection = collection(this.db, 'tracks');
                    
                    this.provider.addScope('profile');
                    this.provider.addScope('email');
                    this.provider.setCustomParameters({
                        prompt: 'select_account'
                    });

                    this.logger.log('success', 'Firebase', 'Firebase initialized successfully');
                    this.setupAuth();
                } catch (error) {
                    this.logger.log('error', 'Firebase', 'Failed to initialize Firebase', {
                        error: error.message,
                        stack: error.stack
                    });
                }
            }

            setupAuth() {
                onAuthStateChanged(this.auth, (user) => {
                    this.currentUser = user;
                    const authSection = document.getElementById('authSection');
                    const mainApp = document.getElementById('mainApp');
                    const userInfo = document.getElementById('userInfo');
                    
                    if (user) {
                        this.logger.log('success', 'Auth', 'User authenticated', {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName
                        });
                        
                        if (authSection) authSection.style.display = 'none';
                        if (mainApp) mainApp.style.display = 'block';
                        if (userInfo) userInfo.textContent = user.displayName || user.email;
                        
                        // Load tracks for authenticated user
                        this.loadTracks();
                    } else {
                        this.logger.log('info', 'Auth', 'User not authenticated');
                        if (authSection) authSection.style.display = 'flex';
                        if (mainApp) mainApp.style.display = 'none';
                    }
                });
            }

            async signInWithGoogle() {
                try {
                    this.logger.log('info', 'Auth', 'Starting Google sign-in');
                    const result = await signInWithPopup(this.auth, this.provider);
                    this.logger.log('success', 'Auth', 'Google sign-in successful', {
                        uid: result.user.uid,
                        email: result.user.email
                    });
                    return result.user;
                } catch (error) {
                    this.logger.log('error', 'Auth', 'Google sign-in failed', {
                        code: error.code,
                        message: error.message
                    });
                    throw error;
                }
            }

            async signInWithEmail(email, password) {
                try {
                    this.logger.log('info', 'Auth', 'Starting email sign-in', { email });
                    const result = await signInWithEmailAndPassword(this.auth, email, password);
                    this.logger.log('success', 'Auth', 'Email sign-in successful', {
                        uid: result.user.uid,
                        email: result.user.email
                    });
                    return result.user;
                } catch (error) {
                    this.logger.log('error', 'Auth', 'Email sign-in failed', {
                        code: error.code,
                        message: error.message
                    });
                    throw error;
                }
            }

            async signUpWithEmail(email, password) {
                try {
                    this.logger.log('info', 'Auth', 'Starting email sign-up', { email });
                    const result = await createUserWithEmailAndPassword(this.auth, email, password);
                    this.logger.log('success', 'Auth', 'Email sign-up successful', {
                        uid: result.user.uid,
                        email: result.user.email
                    });
                    return result.user;
                } catch (error) {
                    this.logger.log('error', 'Auth', 'Email sign-up failed', {
                        code: error.code,
                        message: error.message
                    });
                    throw error;
                }
            }

            async signOut() {
                try {
                    this.logger.log('info', 'Auth', 'Signing out');
                    await signOut(this.auth);
                    this.logger.log('success', 'Auth', 'Sign-out successful');
                } catch (error) {
                    this.logger.log('error', 'Auth', 'Sign-out failed', {
                        message: error.message
                    });
                    throw error;
                }
            }

            async addTrack(trackData) {
                if (!this.currentUser) {
                    throw new Error('User not authenticated');
                }
                
                try {
                    this.logger.log('info', 'Firestore', 'Adding track to database', trackData);
                    
                    const docRef = await addDoc(this.tracksCollection, {
                        ...trackData,
                        userId: this.currentUser.uid,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    
                    this.logger.log('success', 'Firestore', 'Track added successfully', {
                        id: docRef.id,
                        userId: this.currentUser.uid
                    });
                    
                    return docRef.id;
                } catch (error) {
                    this.logger.log('error', 'Firestore', 'Failed to add track', {
                        error: error.message,
                        trackData
                    });
                    throw error;
                }
            }

            async loadTracks() {
                if (!this.currentUser) return;
                
                try {
                    this.logger.log('info', 'Firestore', 'Loading tracks from database');
                    
                    const q = query(this.tracksCollection, orderBy('createdAt', 'desc'));
                    const snapshot = await getDocs(q);
                    
                    const tracks = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.userId === this.currentUser.uid) {
                            tracks.push({
                                id: doc.id,
                                ...data
                            });
                        }
                    });
                    
                    this.logger.log('success', 'Firestore', `Loaded ${tracks.length} tracks`);
                    this.renderTracks(tracks);
                    
                } catch (error) {
                    this.logger.log('error', 'Firestore', 'Failed to load tracks', {
                        error: error.message
                    });
                }
            }

            renderTracks(tracks) {
                const tracksList = document.getElementById('tracksList');
                if (!tracksList) return;

                if (tracks.length === 0) {
                    tracksList.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-music fa-3x mb-3 opacity-50"></i>
                            <p>No hay m√∫sica subida a√∫n</p>
                        </div>
                    `;
                    return;
                }

                tracksList.innerHTML = tracks.map(track => `
                    <div class="track-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${track.title || 'Sin t√≠tulo'}</h6>
                                <p class="text-muted mb-2">${track.artist || 'Artista desconocido'}</p>
                                <small class="text-muted">
                                    <i class="fas fa-cloud"></i> ${track.cloudinaryId || 'ID no disponible'}
                                </small>
                            </div>
                            <div class="track-controls">
                                ${track.audioUrl ? `
                                    <button class="btn btn-outline-primary btn-sm" onclick="playTrack('${track.audioUrl}')">
                                        <i class="fas fa-play"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteTrack('${track.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            async deleteTrack(trackId) {
                if (!this.currentUser) throw new Error('User not authenticated');
                
                try {
                    this.logger.log('info', 'Firestore', 'Deleting track', { trackId });
                    await deleteDoc(doc(this.db, 'tracks', trackId));
                    this.logger.log('success', 'Firestore', 'Track deleted successfully', { trackId });
                    this.loadTracks(); // Refresh the list
                } catch (error) {
                    this.logger.log('error', 'Firestore', 'Failed to delete track', {
                        trackId,
                        error: error.message
                    });
                    throw error;
                }
            }
        }

        // Initialize application
        let mobileLogger, firebaseService, cloudinaryUploader;
        let selectedFiles = [];
        let isUploading = false;

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize logger first
            mobileLogger = new MobileDebugLogger();
            window.mobileLogger = mobileLogger;

            // Initialize services
            firebaseService = new FirebaseService(mobileLogger);
            cloudinaryUploader = new CloudinaryUploader(mobileLogger);
            
            // Make services globally available
            window.firebaseService = firebaseService;
            window.cloudinaryUploader = cloudinaryUploader;

            // Setup event listeners
            setupEventListeners();
            
            mobileLogger.log('success', 'App', 'Application initialized successfully');
        });

        function setupEventListeners() {
            // Google Sign In
            document.getElementById('googleSignInBtn')?.addEventListener('click', async () => {
                mobileLogger.log('info', 'UI', 'Google sign-in button clicked');
                
                if (!firebaseService) {
                    mobileLogger.log('error', 'Auth', 'Firebase service not initialized');
                    showToast('Error: Servicio de autenticaci√≥n no disponible', 'danger');
                    return;
                }
                
                try {
                    showToast('Iniciando sesi√≥n con Google...', 'info');
                    await firebaseService.signInWithGoogle();
                } catch (error) {
                    mobileLogger.log('error', 'Auth', 'Google sign-in error', {
                        code: error.code,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // Provide specific error messages for common issues
                    let errorMessage = 'Error al iniciar sesi√≥n con Google';
                    if (error.code === 'auth/popup-blocked') {
                        errorMessage = 'El navegador bloque√≥ la ventana emergente. Permite ventanas emergentes para este sitio.';
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Inicio de sesi√≥n cancelado.';
                    } else if (error.code === 'auth/unauthorized-domain') {
                        errorMessage = 'Dominio no autorizado. Contacta al administrador.';
                    } else if (error.message) {
                        errorMessage += ': ' + error.message;
                    }
                    
                    showToast(errorMessage, 'danger');
                }
            });

            // Email Sign In
            document.getElementById('emailSignInForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                mobileLogger.log('info', 'UI', 'Email sign-in form submitted');
                
                const email = document.getElementById('emailInput').value;
                const password = document.getElementById('passwordInput').value;
                
                if (!email || !password) {
                    showToast('Por favor ingresa email y contrase√±a', 'warning');
                    return;
                }
                
                if (!firebaseService) {
                    mobileLogger.log('error', 'Auth', 'Firebase service not initialized');
                    showToast('Error: Servicio de autenticaci√≥n no disponible', 'danger');
                    return;
                }
                
                try {
                    showToast('Iniciando sesi√≥n...', 'info');
                    await firebaseService.signInWithEmail(email, password);
                } catch (error) {
                    mobileLogger.log('error', 'Auth', 'Email sign-in error', {
                        code: error.code,
                        message: error.message,
                        email: email
                    });
                    
                    // Provide specific error messages for common issues
                    let errorMessage = 'Error al iniciar sesi√≥n';
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'Usuario no encontrado. ¬øQuieres crear una cuenta?';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Contrase√±a incorrecta.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Email inv√°lido.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Demasiados intentos. Intenta m√°s tarde.';
                    } else if (error.message) {
                        errorMessage += ': ' + error.message;
                    }
                    
                    showToast(errorMessage, 'danger');
                }
            });

            // Sign Up
            document.getElementById('signUpBtn')?.addEventListener('click', async () => {
                mobileLogger.log('info', 'UI', 'Sign-up button clicked');
                
                const email = document.getElementById('emailInput').value;
                const password = document.getElementById('passwordInput').value;
                
                if (!email || !password) {
                    showToast('Por favor ingresa email y contrase√±a', 'warning');
                    return;
                }
                
                if (password.length < 6) {
                    showToast('La contrase√±a debe tener al menos 6 caracteres', 'warning');
                    return;
                }
                
                if (!firebaseService) {
                    mobileLogger.log('error', 'Auth', 'Firebase service not initialized');
                    showToast('Error: Servicio de autenticaci√≥n no disponible', 'danger');
                    return;
                }
                
                try {
                    showToast('Creando cuenta...', 'info');
                    await firebaseService.signUpWithEmail(email, password);
                    showToast('¬°Cuenta creada exitosamente!', 'success');
                } catch (error) {
                    mobileLogger.log('error', 'Auth', 'Sign-up error', {
                        code: error.code,
                        message: error.message,
                        email: email
                    });
                    
                    // Provide specific error messages for common issues
                    let errorMessage = 'Error al crear cuenta';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este email ya est√° registrado. Intenta iniciar sesi√≥n.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Email inv√°lido.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Contrase√±a muy d√©bil. Usa al menos 6 caracteres.';
                    } else if (error.message) {
                        errorMessage += ': ' + error.message;
                    }
                    
                    showToast(errorMessage, 'danger');
                }
            });

            // Sign Out
            document.getElementById('signOutBtn')?.addEventListener('click', async () => {
                try {
                    await firebaseService.signOut();
                } catch (error) {
                    showToast('Error al cerrar sesi√≥n: ' + error.message, 'danger');
                }
            });

            // Upload Button
            document.getElementById('uploadBtn')?.addEventListener('click', uploadSelectedFiles);

            // Refresh Button
            document.getElementById('refreshBtn')?.addEventListener('click', () => {
                firebaseService.loadTracks();
            });
        }

        // Global functions
        window.handleFileSelect = function(event) {
            const files = Array.from(event.target.files);
            selectedFiles = files;
            
            mobileLogger.log('info', 'File Selection', `Selected ${files.length} files`, {
                fileNames: files.map(f => f.name),
                totalSize: `${(files.reduce((sum, f) => sum + f.size, 0) / 1024 / 1024).toFixed(2)} MB`
            });
            
            displaySelectedFiles(files);
        };

        function displaySelectedFiles(files) {
            const selectedFilesDiv = document.getElementById('selectedFiles');
            const filesList = document.getElementById('filesList');
            
            if (files.length === 0) {
                selectedFilesDiv.style.display = 'none';
                return;
            }
            
            selectedFilesDiv.style.display = 'block';
            filesList.innerHTML = files.map(file => `
                <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                    <div>
                        <strong>${file.name}</strong>
                        <br>
                        <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                    </div>
                    <i class="fas fa-music text-primary"></i>
                </div>
            `).join('');
        }

        async function uploadSelectedFiles() {
            if (selectedFiles.length === 0) {
                showToast('No hay archivos seleccionados', 'warning');
                return;
            }
            
            if (isUploading) {
                showToast('Ya hay una subida en progreso', 'warning');
                return;
            }
            
            isUploading = true;
            showUploadOverlay();
            
            mobileLogger.log('info', 'Upload Batch', `Starting batch upload of ${selectedFiles.length} files`);
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                
                try {
                    updateUploadProgress(
                        (i / selectedFiles.length) * 100,
                        `Subiendo ${file.name}...`,
                        `Archivo ${i + 1} de ${selectedFiles.length}`
                    );
                    
                    // Upload to Cloudinary
                    const cloudinaryResult = await cloudinaryUploader.uploadFile(file, (progress) => {
                        const overallProgress = ((i / selectedFiles.length) + (progress / 100 / selectedFiles.length)) * 100;
                        updateUploadProgress(
                            overallProgress,
                            `Subiendo ${file.name}...`,
                            `${progress.toFixed(1)}% completado`
                        );
                    });
                    
                    // Extract metadata
                    const metadata = cloudinaryUploader.extractMetadata(file.name);
                    
                    // Save to Firebase
                    const trackData = {
                        title: metadata.title,
                        artist: metadata.artist,
                        filename: file.name,
                        cloudinaryId: cloudinaryResult.public_id,
                        audioUrl: cloudinaryResult.secure_url,
                        format: cloudinaryResult.format,
                        duration: cloudinaryResult.duration,
                        size: cloudinaryResult.bytes
                    };
                    
                    await firebaseService.addTrack(trackData);
                    successCount++;
                    
                    mobileLogger.log('success', 'Upload Complete', `Successfully uploaded ${file.name}`, trackData);
                    
                } catch (error) {
                    errorCount++;
                    mobileLogger.log('error', 'Upload Failed', `Failed to upload ${file.name}`, {
                        error: error.message,
                        fileName: file.name
                    });
                    showToast(`Error subiendo ${file.name}: ${error.message}`, 'danger');
                }
            }
            
            isUploading = false;
            hideUploadOverlay();
            
            // Show summary
            if (successCount > 0) {
                showToast(`${successCount} archivo(s) subido(s) exitosamente`, 'success');
                firebaseService.loadTracks();
            }
            
            if (errorCount > 0) {
                showToast(`${errorCount} archivo(s) fallaron`, 'warning');
            }
            
            // Clear selection
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            displaySelectedFiles([]);
            
            mobileLogger.log('info', 'Upload Batch Complete', 
                `Batch upload completed: ${successCount} successful, ${errorCount} failed`);
        }

        function showUploadOverlay() {
            document.getElementById('uploadOverlay').style.display = 'block';
        }

        function hideUploadOverlay() {
            document.getElementById('uploadOverlay').style.display = 'none';
        }

        function updateUploadProgress(percentage, title, status) {
            document.getElementById('uploadProgressBar').style.width = percentage + '%';
            document.getElementById('uploadTitle').textContent = title;
            document.getElementById('uploadStatus').textContent = status;
        }

        window.cancelUpload = function() {
            if (isUploading) {
                cloudinaryUploader.cancelAllUploads();
                isUploading = false;
                hideUploadOverlay();
                showToast('Subida cancelada', 'info');
                mobileLogger.log('warning', 'Upload', 'Upload cancelled by user');
            }
        };

        window.toggleDebugConsole = function() {
            mobileLogger.toggle();
        };

        window.clearDebugLog = function() {
            mobileLogger.clear();
        };

        window.deleteTrack = async function(trackId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta canci√≥n?')) {
                try {
                    await firebaseService.deleteTrack(trackId);
                    showToast('Canci√≥n eliminada', 'success');
                } catch (error) {
                    showToast('Error al eliminar: ' + error.message, 'danger');
                }
            }
        };

        window.playTrack = function(url) {
            // Simple audio playback
            const audio = new Audio(url);
            audio.play().catch(error => {
                mobileLogger.log('error', 'Audio', 'Failed to play audio', {
                    url,
                    error: error.message
                });
                showToast('Error al reproducir audio: ' + error.message, 'danger');
            });
        };

        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast mobile-toast" role="alert">
                    <div class="toast-header">
                        <i class="fas fa-info-circle text-${type} me-2"></i>
                        <strong class="me-auto">ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement);
            bsToast.show();
            
            // Auto-remove after hide
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
    </script>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
