<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            overscroll-behavior: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px; /* Espacio para la barra inferior */
        }
        
        .progress-container {
            height: 5px;
            background-color: #333;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #1DB954;
            border-radius: 5px;
            transition: width 0.1s;
        }
        
        .music-controls button {
            transition: transform 0.1s;
        }
        
        .music-controls button:active {
            transform: scale(0.95);
        }
        
        .playlist-item {
            transition: background-color 0.2s;
        }
        
        .playlist-item:active {
            background-color: #333;
        }
        
        .visualizer-container {
            height: 60px;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            padding: 0 5px;
        }
        
        .visualizer-bar {
            width: 3px;
            background-color: #1DB954;
            margin: 0 1px;
            border-radius: 2px 2px 0 0;
            transition: height 0.1s ease;
        }
        
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 5px;
            border-radius: 5px;
            background: #333;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
        }
        
        .volume-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
        }
        
        .tab-active {
            color: #1DB954;
            border-bottom: 2px solid #1DB954;
        }
        
        .custom-file-upload {
            display: inline-block;
            padding: 10px 15px;
            cursor: pointer;
            background-color: #1DB954;
            color: white;
            border-radius: 5px;
            text-align: center;
            transition: background-color 0.3s;
        }
        
        .custom-file-upload:hover {
            background-color: #18a348;
        }
        
        #fileInput {
            display: none;
        }
        
        .eq-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 60px;
            margin: 0;
            transform: rotate(270deg);
            background: transparent;
        }
        
        .eq-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 15px;
            width: 15px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
            margin-top: -5px;
        }
        
        .eq-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 5px;
            background: #333;
            border-radius: 3px;
        }
        
        .eq-container {
            display: flex;
            justify-content: space-around;
            height: 80px;
            align-items: center;
        }
        
        .eq-band {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .playing {
            color: #1DB954;
            animation: pulse 2s infinite;
        }
        
        /* Arreglos para problemas de superposici√≥n */
        .header-spacer {
            height: 120px; /* Altura del header + tabs */
        }
        
        .main-container {
            padding-bottom: 80px; /* Espacio para la barra inferior */
            padding-top: 20px; /* Espacio adicional en la parte superior */
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #1DB954;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Auth Styles */
        .auth-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }

        .auth-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 133, 244, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #1DB954;
        }

        .user-name {
            font-weight: 600;
            color: #e0e0e0;
        }

        .sign-out-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sign-out-btn:hover {
            background: #c82333;
        }

        .upload-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .upload-status.success {
            background: rgba(29, 185, 84, 0.1);
            color: #1DB954;
            border: 1px solid rgba(29, 185, 84, 0.3);
        }

        .upload-status.error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .upload-status.loading {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top: 2px solid #1DB954;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 bg-black bg-opacity-95 z-10 shadow-lg">
        <div class="flex justify-between items-center p-4">
            <div class="flex items-center">
                <i class="fas fa-music text-green-500 text-xl mr-2"></i>
                <h1 class="text-xl font-bold text-white">ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê</h1>
            </div>
            <div>
                <!-- User Authentication Section -->
                <div id="authSection" class="flex items-center gap-3">
                    <div id="loginContainer" style="display: none;">
                        <button id="googleSignInBtn" class="auth-btn text-sm py-2 px-3">
                            <i class="fab fa-google"></i>
                            Iniciar sesi√≥n
                        </button>
                    </div>
                    <div id="userContainer" style="display: none;">
                        <div class="user-info">
                            <img id="userPhoto" class="user-avatar" alt="User Avatar">
                            <span id="userName" class="user-name text-sm"></span>
                            <button id="signOutBtn" class="sign-out-btn text-xs">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button id="settingsBtn" class="text-gray-300 p-2 ml-2">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="flex justify-around border-b border-gray-800">
            <button id="tabPlayer" class="py-3 px-4 tab-active flex-1 text-center">
                <i class="fas fa-play mr-1"></i> Reproductor
            </button>
            <button id="tabPlaylist" class="py-3 px-4 text-gray-400 flex-1 text-center">
                <i class="fas fa-list mr-1"></i> Biblioteca
            </button>
            <button id="tabEqualizer" class="py-3 px-4 text-gray-400 flex-1 text-center">
                <i class="fas fa-sliders-h mr-1"></i> Ecualizador
            </button>
        </div>
    </header>

    <!-- Spacer para evitar superposici√≥n con el header -->
    <div class="header-spacer"></div>

    <main class="main-container px-4">
        <!-- Player Tab -->
        <section id="playerSection" class="block">
            <div class="flex flex-col items-center">
                <!-- Album Art -->
                <div class="w-64 h-64 bg-gray-800 rounded-lg mb-6 flex items-center justify-center overflow-hidden shadow-xl" id="albumArt">
                    <i class="fas fa-music text-5xl text-gray-600"></i>
                </div>
                
                <!-- Song Info -->
                <div class="w-full text-center mb-6">
                    <h2 id="songTitle" class="text-xl font-semibold text-white truncate">Selecciona una canci√≥n</h2>
                    <p id="songArtist" class="text-gray-400 truncate">Artista</p>
                </div>
                
                <!-- Audio Visualizer -->
                <div class="visualizer-container w-full mb-4" id="visualizer">
                    <!-- Bars will be added dynamically -->
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full mb-2">
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="music-controls flex items-center justify-center w-full mt-6">
                    <button id="shuffleBtn" class="mx-3 text-gray-400 focus:outline-none">
                        <i class="fas fa-random text-lg"></i>
                    </button>
                    <button id="prevBtn" class="mx-3 text-white focus:outline-none">
                        <i class="fas fa-step-backward text-xl"></i>
                    </button>
                    <button id="playBtn" class="mx-4 bg-green-500 w-14 h-14 rounded-full flex items-center justify-center text-white focus:outline-none shadow-lg">
                        <i class="fas fa-play text-xl" id="playIcon"></i>
                    </button>
                    <button id="nextBtn" class="mx-3 text-white focus:outline-none">
                        <i class="fas fa-step-forward text-xl"></i>
                    </button>
                    <button id="repeatBtn" class="mx-3 text-gray-400 focus:outline-none">
                        <i class="fas fa-redo-alt text-lg"></i>
                    </button>
                </div>
                
                <!-- Volume Control -->
                <div class="flex items-center w-full mt-6">
                    <i class="fas fa-volume-down text-gray-400 mr-2"></i>
                    <input type="range" min="0" max="100" value="80" class="volume-slider" id="volumeSlider">
                    <i class="fas fa-volume-up text-gray-400 ml-2"></i>
                </div>
            </div>
        </section>
        
        <!-- Playlist Tab -->
        <section id="playlistSection" class="hidden mt-6">
            <div class="mb-6">
                <button id="cloudinaryUploadBtn" class="custom-file-upload w-full mb-4">
                    <i class="fas fa-cloud-upload-alt mr-2"></i> Subir m√∫sica a la nube
                </button>
                <div id="uploadStatus"></div>
            </div>
            
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="Buscar canciones..." class="w-full bg-gray-800 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            
            <div id="playlistContainer" class="space-y-2">
                <div class="text-center text-gray-500 py-10" id="emptyState">
                    <i class="fas fa-music text-4xl mb-2"></i>
                    <p>No hay canciones en tu biblioteca</p>
                    <p class="text-sm">Inicia sesi√≥n y agrega canciones para comenzar</p>
                </div>
            </div>
        </section>
        
        <!-- Equalizer Tab -->
        <section id="equalizerSection" class="hidden mt-6">
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">Ecualizador</h3>
                <div class="eq-container">
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq60">
                        <span class="text-xs mt-2">60Hz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq170">
                        <span class="text-xs mt-2">170Hz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq310">
                        <span class="text-xs mt-2">310Hz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq600">
                        <span class="text-xs mt-2">600Hz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq1k">
                        <span class="text-xs mt-2">1kHz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq3k">
                        <span class="text-xs mt-2">3kHz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq6k">
                        <span class="text-xs mt-2">6kHz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq12k">
                        <span class="text-xs mt-2">12kHz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq14k">
                        <span class="text-xs mt-2">14kHz</span>
                    </div>
                    <div class="eq-band">
                        <input type="range" min="-12" max="12" value="0" class="eq-slider" id="eq16k">
                        <span class="text-xs mt-2">16kHz</span>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="text-md font-semibold mb-3">Presets</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="bg-gray-700 text-white py-2 px-3 rounded text-sm" onclick="setEQPreset('normal')">Normal</button>
                        <button class="bg-gray-700 text-white py-2 px-3 rounded text-sm" onclick="setEQPreset('rock')">Rock</button>
                        <button class="bg-gray-700 text-white py-2 px-3 rounded text-sm" onclick="setEQPreset('pop')">Pop</button>
                        <button class="bg-gray-700 text-white py-2 px-3 rounded text-sm" onclick="setEQPreset('jazz')">Jazz</button>
                        <button class="bg-gray-700 text-white py-2 px-3 rounded text-sm" onclick="setEQPreset('classical')">Cl√°sica</button>
                        <button class="bg-gray-700 text-white py-2 px-3 rounded text-sm" onclick="setEQPreset('bass')">Bass Boost</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Audio Element -->
    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCmFq5ISq59Ql84Ntf_QiynlQtMX31zmwo",
            authDomain: "fuck-musix.firebaseapp.com",
            projectId: "fuck-musix",
            storageBucket: "fuck-musix.firebasestorage.app",
            messagingSenderId: "858119028230",
            appId: "1:858119028230:web:63dc3168ac63221a82cd87",
            databaseURL: "https://fuck-musix-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Configure Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('profile');
        googleProvider.addScope('email');

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloud_name: 'dgy5bftjt',
            api_key: '653338899368839',
            api_secret: 'Hv8eC6PZk7wgGRdBc9UnVDT9SPI'
        };

        // Application State
        let playlist = [];
        let currentTrackIndex = -1;
        let isPlaying = false;
        let currentUser = null;
        let isShuffle = false;
        let repeatMode = 0; // 0: no repeat, 1: repeat all, 2: repeat one
        let audioContext;
        let analyser;
        let source;
        let equalizer = {};

        // DOM Elements
        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const repeatBtn = document.getElementById('repeatBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const currentTime = document.getElementById('currentTime');
        const totalTime = document.getElementById('totalTime');
        const songTitle = document.getElementById('songTitle');
        const songArtist = document.getElementById('songArtist');
        const albumArt = document.getElementById('albumArt');
        const playlistContainer = document.getElementById('playlistContainer');
        const searchInput = document.getElementById('searchInput');
        const visualizer = document.getElementById('visualizer');
        const emptyState = document.getElementById('emptyState');

        // Tab elements
        const tabPlayer = document.getElementById('tabPlayer');
        const tabPlaylist = document.getElementById('tabPlaylist');
        const tabEqualizer = document.getElementById('tabEqualizer');
        const playerSection = document.getElementById('playerSection');
        const playlistSection = document.getElementById('playlistSection');
        const equalizerSection = document.getElementById('equalizerSection');

        // Auth elements
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const loginContainer = document.getElementById('loginContainer');
        const userContainer = document.getElementById('userContainer');
        const userPhoto = document.getElementById('userPhoto');
        const userName = document.getElementById('userName');

        // Upload elements
        const cloudinaryUploadBtn = document.getElementById('cloudinaryUploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');

        // Initialize Cloudinary Upload Widget
        const uploadWidget = cloudinary.createUploadWidget({
            cloudName: cloudinaryConfig.cloud_name,
            uploadPreset: 'ml_default',
            resourceType: 'auto',
            clientAllowedFormats: ['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac'],
            maxFileSize: 50000000, // 50MB
            multiple: false,
            folder: 'full-musix'
        }, (error, result) => {
            if (!error && result && result.event === "success") {
                handleUploadSuccess(result.info);
            } else if (error) {
                handleUploadError(error);
            }
        });

        // Upload button event listener
        cloudinaryUploadBtn.addEventListener('click', () => {
            if (!currentUser) {
                showUploadStatus('Debes iniciar sesi√≥n para subir m√∫sica', 'error');
                return;
            }
            uploadWidget.open();
        });

        // Handle successful upload
        async function handleUploadSuccess(uploadResult) {
            try {
                showUploadStatus('Guardando en la base de datos...', 'loading');
                
                const trackData = {
                    id: Date.now().toString(),
                    title: uploadResult.original_filename || 'Canci√≥n sin t√≠tulo',
                    artist: 'Artista desconocido',
                    url: uploadResult.secure_url,
                    duration: uploadResult.duration || 0,
                    publicId: uploadResult.public_id,
                    uploadedAt: new Date().toISOString()
                };

                // Save to Firebase (user-specific)
                if (currentUser) {
                    await database.ref(`users/${currentUser.uid}/tracks`).push(trackData);
                } else {
                    await database.ref('tracks').push(trackData);
                }
                
                showUploadStatus('¬°Canci√≥n subida exitosamente!', 'success');
                
                // Refresh playlist
                loadPlaylist();
                
            } catch (error) {
                console.error('Error saving track:', error);
                handleUploadError(error);
            }
        }

        // Handle upload error
        function handleUploadError(error) {
            console.error('Upload error:', error);
            showUploadStatus('Error al subir. Int√©ntalo de nuevo.', 'error');
        }

        // Show upload status
        function showUploadStatus(message, type) {
            uploadStatus.innerHTML = '';
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `upload-status ${type}`;
            
            if (type === 'loading') {
                statusDiv.innerHTML = `
                    <div class="spinner"></div>
                    <span>${message}</span>
                `;
            } else {
                statusDiv.textContent = message;
            }
            
            uploadStatus.appendChild(statusDiv);
            
            if (type !== 'loading') {
                setTimeout(() => {
                    uploadStatus.innerHTML = '';
                }, 5000);
            }
        }

        // Authentication Functions
        function signInWithGoogle() {
            auth.signInWithPopup(googleProvider)
                .then((result) => {
                    currentUser = result.user;
                    updateAuthUI();
                    loadPlaylist();
                    showUploadStatus('¬°Bienvenido! Tu biblioteca musical est√° disponible.', 'success');
                })
                .catch((error) => {
                    console.error('Error signing in:', error);
                    showUploadStatus('Error al iniciar sesi√≥n. Int√©ntalo de nuevo.', 'error');
                });
        }

        function signOut() {
            auth.signOut()
                .then(() => {
                    currentUser = null;
                    playlist = [];
                    updateAuthUI();
                    renderPlaylist();
                    showUploadStatus('Sesi√≥n cerrada exitosamente.', 'success');
                })
                .catch((error) => {
                    console.error('Error signing out:', error);
                });
        }

        function updateAuthUI() {
            if (currentUser) {
                loginContainer.style.display = 'none';
                userContainer.style.display = 'block';
                userPhoto.src = currentUser.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMxREI5NTQiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTRDOC42ODYyOSAxNCA2IDE2LjY4NjMgNiAyMFYyMkgxOFYyMEMxOCAxNi42ODYzIDE1LjMxMzcgMTQgMTIgMTRaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+';
                userName.textContent = currentUser.displayName || currentUser.email;
                cloudinaryUploadBtn.disabled = false;
            } else {
                loginContainer.style.display = 'block';
                userContainer.style.display = 'none';
                cloudinaryUploadBtn.disabled = true;
            }
        }

        // Auth Event Listeners
        googleSignInBtn.addEventListener('click', signInWithGoogle);
        signOutBtn.addEventListener('click', signOut);

        // Monitor auth state changes
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            updateAuthUI();
            if (user) {
                loadPlaylist();
            } else {
                playlist = [];
                renderPlaylist();
            }
        });

        // Load playlist from Firebase
        async function loadPlaylist() {
            try {
                let snapshot;
                if (currentUser) {
                    snapshot = await database.ref(`users/${currentUser.uid}/tracks`).once('value');
                } else {
                    snapshot = await database.ref('tracks').once('value');
                }
                
                const tracks = snapshot.val();
                
                if (tracks) {
                    playlist = Object.keys(tracks).map(key => ({
                        firebaseKey: key,
                        ...tracks[key]
                    }));
                } else {
                    playlist = [];
                }
                
                renderPlaylist();
                
            } catch (error) {
                console.error('Error loading playlist:', error);
                showUploadStatus('Error al cargar la biblioteca', 'error');
            }
        }

        // Render playlist
        function renderPlaylist() {
            if (playlist.length === 0) {
                playlistContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-10">
                        <i class="fas fa-music text-4xl mb-2"></i>
                        <p>No hay canciones en tu biblioteca</p>
                        <p class="text-sm">${currentUser ? 'Sube canciones para comenzar' : 'Inicia sesi√≥n y agrega canciones para comenzar'}</p>
                    </div>
                `;
                return;
            }

            const filteredPlaylist = searchInput.value ? 
                playlist.filter(track => 
                    track.title.toLowerCase().includes(searchInput.value.toLowerCase()) ||
                    track.artist.toLowerCase().includes(searchInput.value.toLowerCase())
                ) : playlist;

            playlistContainer.innerHTML = filteredPlaylist.map((track, index) => {
                const originalIndex = playlist.indexOf(track);
                return `
                    <div class="playlist-item bg-gray-800 p-3 rounded-lg flex items-center justify-between cursor-pointer hover:bg-gray-700 ${originalIndex === currentTrackIndex ? 'playing' : ''}" 
                         onclick="playTrack(${originalIndex})">
                        <div class="flex items-center flex-1">
                            <i class="fas ${originalIndex === currentTrackIndex && isPlaying ? 'fa-pause' : 'fa-play'} text-green-500 mr-3"></i>
                            <div>
                                <div class="text-white font-medium truncate">${track.title}</div>
                                <div class="text-gray-400 text-sm truncate">${track.artist}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400 text-xs">${formatTime(track.duration)}</span>
                            <button class="text-red-500 hover:text-red-400 p-1" onclick="deleteTrack(event, '${track.firebaseKey}', ${originalIndex})">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Delete track function
        async function deleteTrack(event, firebaseKey, index) {
            event.stopPropagation();
            
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta canci√≥n?')) return;
            
            try {
                let ref;
                if (currentUser) {
                    ref = database.ref(`users/${currentUser.uid}/tracks/${firebaseKey}`);
                } else {
                    ref = database.ref(`tracks/${firebaseKey}`);
                }
                
                await ref.remove();
                
                // Update playlist
                playlist.splice(index, 1);
                
                // Adjust current track index if necessary
                if (index === currentTrackIndex) {
                    // If current track was deleted, stop playback
                    audioPlayer.pause();
                    isPlaying = false;
                    playIcon.className = 'fas fa-play text-xl';
                    currentTrackIndex = -1;
                    songTitle.textContent = 'Selecciona una canci√≥n';
                    songArtist.textContent = 'Artista';
                    albumArt.innerHTML = '<i class="fas fa-music text-5xl text-gray-600"></i>';
                } else if (index < currentTrackIndex) {
                    currentTrackIndex--;
                }
                
                renderPlaylist();
                showUploadStatus('Canci√≥n eliminada exitosamente', 'success');
                
            } catch (error) {
                console.error('Error deleting track:', error);
                showUploadStatus('Error al eliminar la canci√≥n', 'error');
            }
        }

        // Play specific track
        function playTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            
            currentTrackIndex = index;
            const track = playlist[index];
            
            // Update UI
            songTitle.textContent = track.title;
            songArtist.textContent = track.artist;
            
            // Load audio
            audioPlayer.src = track.url;
            audioPlayer.load();
            
            // Update album art (placeholder)
            albumArt.innerHTML = '<i class="fas fa-music text-5xl text-gray-600"></i>';
            
            // Play audio
            audioPlayer.play().then(() => {
                isPlaying = true;
                playIcon.className = 'fas fa-pause text-xl';
                renderPlaylist();
            }).catch(error => {
                console.error('Error playing audio:', error);
                showUploadStatus('Error al reproducir la canci√≥n', 'error');
            });
        }

        // Format time helper
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Tab Navigation
        function showTab(tabName) {
            // Hide all sections
            playerSection.classList.add('hidden');
            playlistSection.classList.add('hidden');
            equalizerSection.classList.add('hidden');
            
            // Remove active class from all tabs
            tabPlayer.classList.remove('tab-active');
            tabPlayer.classList.add('text-gray-400');
            tabPlaylist.classList.remove('tab-active');
            tabPlaylist.classList.add('text-gray-400');
            tabEqualizer.classList.remove('tab-active');
            tabEqualizer.classList.add('text-gray-400');
            
            // Show selected section and activate tab
            switch(tabName) {
                case 'player':
                    playerSection.classList.remove('hidden');
                    tabPlayer.classList.add('tab-active');
                    tabPlayer.classList.remove('text-gray-400');
                    break;
                case 'playlist':
                    playlistSection.classList.remove('hidden');
                    tabPlaylist.classList.add('tab-active');
                    tabPlaylist.classList.remove('text-gray-400');
                    break;
                case 'equalizer':
                    equalizerSection.classList.remove('hidden');
                    tabEqualizer.classList.add('tab-active');
                    tabEqualizer.classList.remove('text-gray-400');
                    break;
            }
        }

        // Tab event listeners
        tabPlayer.addEventListener('click', () => showTab('player'));
        tabPlaylist.addEventListener('click', () => showTab('playlist'));
        tabEqualizer.addEventListener('click', () => showTab('equalizer'));

        // Audio Controls
        playBtn.addEventListener('click', () => {
            if (playlist.length === 0) {
                showUploadStatus('No hay canciones para reproducir', 'error');
                return;
            }
            
            if (currentTrackIndex === -1) {
                playTrack(0);
                return;
            }
            
            if (isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
                playIcon.className = 'fas fa-play text-xl';
            } else {
                audioPlayer.play().then(() => {
                    isPlaying = true;
                    playIcon.className = 'fas fa-pause text-xl';
                }).catch(error => {
                    console.error('Error playing audio:', error);
                });
            }
            renderPlaylist();
        });

        prevBtn.addEventListener('click', () => {
            if (playlist.length === 0) return;
            
            let newIndex;
            if (isShuffle) {
                newIndex = Math.floor(Math.random() * playlist.length);
            } else {
                newIndex = currentTrackIndex > 0 ? currentTrackIndex - 1 : playlist.length - 1;
            }
            playTrack(newIndex);
        });

        nextBtn.addEventListener('click', () => {
            if (playlist.length === 0) return;
            
            let newIndex;
            if (isShuffle) {
                newIndex = Math.floor(Math.random() * playlist.length);
            } else {
                newIndex = currentTrackIndex < playlist.length - 1 ? currentTrackIndex + 1 : 0;
            }
            playTrack(newIndex);
        });

        shuffleBtn.addEventListener('click', () => {
            isShuffle = !isShuffle;
            shuffleBtn.classList.toggle('text-green-500');
            shuffleBtn.classList.toggle('text-gray-400');
        });

        repeatBtn.addEventListener('click', () => {
            repeatMode = (repeatMode + 1) % 3;
            switch(repeatMode) {
                case 0:
                    repeatBtn.innerHTML = '<i class="fas fa-redo-alt text-lg"></i>';
                    repeatBtn.classList.remove('text-green-500');
                    repeatBtn.classList.add('text-gray-400');
                    break;
                case 1:
                    repeatBtn.innerHTML = '<i class="fas fa-redo-alt text-lg"></i>';
                    repeatBtn.classList.add('text-green-500');
                    repeatBtn.classList.remove('text-gray-400');
                    break;
                case 2:
                    repeatBtn.innerHTML = '<i class="fas fa-redo-alt text-lg"></i><sup>1</sup>';
                    repeatBtn.classList.add('text-green-500');
                    repeatBtn.classList.remove('text-gray-400');
                    break;
            }
        });

        // Volume Control
        volumeSlider.addEventListener('input', (e) => {
            audioPlayer.volume = e.target.value / 100;
        });

        // Progress Bar
        progressContainer.addEventListener('click', (e) => {
            if (audioPlayer.duration) {
                const rect = progressContainer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickRatio = clickX / rect.width;
                audioPlayer.currentTime = clickRatio * audioPlayer.duration;
            }
        });

        // Audio Events
        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressBar.style.width = progress + '%';
                currentTime.textContent = formatTime(audioPlayer.currentTime);
                totalTime.textContent = formatTime(audioPlayer.duration);
            }
        });

        audioPlayer.addEventListener('ended', () => {
            isPlaying = false;
            playIcon.className = 'fas fa-play text-xl';
            
            switch(repeatMode) {
                case 0: // No repeat
                    if (currentTrackIndex < playlist.length - 1) {
                        nextBtn.click();
                    }
                    break;
                case 1: // Repeat all
                    nextBtn.click();
                    break;
                case 2: // Repeat one
                    playTrack(currentTrackIndex);
                    break;
            }
            renderPlaylist();
        });

        // Search functionality
        searchInput.addEventListener('input', renderPlaylist);

        // Initialize visualizer
        function initVisualizer() {
            for (let i = 0; i < 50; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.height = '2px';
                visualizer.appendChild(bar);
            }
        }

        // Animate visualizer
        function animateVisualizer() {
            if (!isPlaying) return;
            
            const bars = visualizer.children;
            for (let i = 0; i < bars.length; i++) {
                const height = Math.random() * 50 + 2;
                bars[i].style.height = height + 'px';
            }
        }

        // EQ Presets
        function setEQPreset(preset) {
            const presets = {
                normal: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                rock: [4, 3, -1, -2, 1, 3, 4, 4, 4, 4],
                pop: [2, 1, 0, -1, -1, 0, 1, 2, 2, 2],
                jazz: [3, 2, 1, 1, -1, -1, 0, 1, 2, 3],
                classical: [4, 3, 2, 0, -1, -1, 0, 2, 3, 4],
                bass: [6, 4, 2, 1, 0, -1, -2, -2, -2, -2]
            };
            
            const values = presets[preset] || presets.normal;
            const sliders = ['eq60', 'eq170', 'eq310', 'eq600', 'eq1k', 'eq3k', 'eq6k', 'eq12k', 'eq14k', 'eq16k'];
            
            sliders.forEach((id, index) => {
                const slider = document.getElementById(id);
                if (slider && values[index] !== undefined) {
                    slider.value = values[index];
                }
            });
        }

        // Initialize app
        initVisualizer();
        updateAuthUI();
        
        // Start visualizer animation
        setInterval(animateVisualizer, 100);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    playBtn.click();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    prevBtn.click();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextBtn.click();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    volumeSlider.value = Math.min(100, parseInt(volumeSlider.value) + 10);
                    volumeSlider.dispatchEvent(new Event('input'));
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    volumeSlider.value = Math.max(0, parseInt(volumeSlider.value) - 10);
                    volumeSlider.dispatchEvent(new Event('input'));
                    break;
            }
        });
    </script>
</body>
</html>