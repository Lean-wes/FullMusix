<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê - Music Player</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: 260 65% 55%; /* #7c3aed */
            --primary-dark: 260 65% 45%; /* #6d28d9 */
            --background: 240 10% 4%; /* #0a0a0f */
            --surface: 240 6% 10%; /* #1a1a1f */
            --surface-light: 240 5% 15%; /* #242429 */
            --text: 0 0% 98%; /* #fafafa */
            --text-muted: 240 5% 65%; /* #a1a1aa */
            --border: 240 6% 20%; /* #2e2e33 */
            --success: 142 76% 36%; /* #22c55e */
            --danger: 0 84% 60%; /* #ef4444 */
            --warning: 45 93% 47%; /* #eab308 */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: hsl(var(--background));
            color: hsl(var(--text));
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--warning)));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: hsl(var(--text-muted));
            font-size: 1.1rem;
        }

        .upload-section {
            background: hsl(var(--surface));
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid hsl(var(--border));
        }

        .upload-btn {
            background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-dark)));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3);
        }

        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .player-section {
            background: hsl(var(--surface));
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid hsl(var(--border));
        }

        .current-track {
            text-align: center;
            margin-bottom: 30px;
        }

        .track-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .track-artist {
            color: hsl(var(--text-muted));
            font-size: 1rem;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: hsl(var(--surface-light));
            border-radius: 3px;
            position: relative;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, hsl(var(--primary)), hsl(var(--warning)));
            border-radius: 3px;
            transition: width 0.1s ease;
            width: 0%;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: hsl(var(--text-muted));
            margin-top: 5px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .control-btn {
            background: hsl(var(--surface-light));
            border: 1px solid hsl(var(--border));
            color: hsl(var(--text));
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: hsl(var(--primary));
            transform: scale(1.1);
        }

        .control-btn.play-pause {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-dark)));
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .volume-slider {
            width: 150px;
            height: 6px;
            background: hsl(var(--surface-light));
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: hsl(var(--primary));
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: hsl(var(--primary));
            cursor: pointer;
            border: none;
        }

        .playlist-section {
            background: hsl(var(--surface));
            border-radius: 12px;
            padding: 30px;
            border: 1px solid hsl(var(--border));
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .playlist-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .playlist-count {
            color: hsl(var(--text-muted));
            font-size: 0.9rem;
        }

        .playlist {
            max-height: 400px;
            overflow-y: auto;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            background: hsl(var(--surface-light));
            border: 1px solid hsl(var(--border));
        }

        .playlist-item:hover {
            background: hsl(var(--primary) / 0.1);
            border-color: hsl(var(--primary));
        }

        .playlist-item.active {
            background: hsl(var(--primary) / 0.2);
            border-color: hsl(var(--primary));
        }

        .playlist-item .play-icon {
            margin-right: 15px;
            font-size: 1.2rem;
            color: hsl(var(--primary));
        }

        .playlist-item .track-info {
            flex: 1;
        }

        .playlist-item .track-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .playlist-item .track-duration {
            color: hsl(var(--text-muted));
            font-size: 0.9rem;
        }

        .playlist-item .delete-btn {
            background: hsl(var(--danger));
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .playlist-item .delete-btn:hover {
            background: hsl(var(--danger) / 0.8);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            color: hsl(var(--text-muted));
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid hsl(var(--surface-light));
            border-top: 2px solid hsl(var(--primary));
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: hsl(var(--text-muted));
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: hsl(var(--border));
        }

        /* Authentication Styles */
        .auth-section {
            margin: 20px 0;
        }

        .auth-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }

        .auth-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 133, 244, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            background: hsl(var(--surface));
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid hsl(var(--border));
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid hsl(var(--primary));
        }

        .user-name {
            font-weight: 600;
            color: hsl(var(--text));
        }

        .sign-out-btn {
            background: hsl(var(--danger));
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sign-out-btn:hover {
            background: hsl(var(--danger) / 0.8);
        }

        .error-message {
            background: hsl(var(--danger) / 0.1);
            color: hsl(var(--danger));
            padding: 15px;
            border-radius: 8px;
            border: 1px solid hsl(var(--danger) / 0.3);
            margin: 10px 0;
        }

        .success-message {
            background: hsl(var(--success) / 0.1);
            color: hsl(var(--success));
            padding: 15px;
            border-radius: 8px;
            border: 1px solid hsl(var(--success) / 0.3);
            margin: 10px 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .upload-section,
            .player-section,
            .playlist-section {
                padding: 20px;
            }

            .controls {
                gap: 15px;
            }

            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }

            .control-btn.play-pause {
                width: 55px;
                height: 55px;
                font-size: 1.3rem;
            }

            .volume-container {
                flex-direction: column;
                gap: 10px;
            }

            .volume-slider {
                width: 200px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .playlist-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .playlist-item .track-info {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ùêÖùêÆùê•ùê• ùêå‡∏¢‡∏£‡πÄ◊ê</h1>
            <p>Your Ultimate Music Experience</p>
            
            <!-- User Authentication Section -->
            <div id="authSection" class="auth-section">
                <div id="loginContainer" style="display: none;">
                    <button id="googleSignInBtn" class="auth-btn">
                        <i class="fab fa-google"></i>
                        Sign in with Google
                    </button>
                </div>
                <div id="userContainer" style="display: none;">
                    <div class="user-info">
                        <img id="userPhoto" class="user-avatar" alt="User Avatar">
                        <span id="userName" class="user-name"></span>
                        <button id="signOutBtn" class="sign-out-btn">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <section class="upload-section">
            <button id="uploadBtn" class="upload-btn">
                <i class="fas fa-cloud-upload-alt"></i>
                Upload Music
            </button>
            <div id="uploadStatus"></div>
        </section>

        <section class="player-section">
            <div class="current-track">
                <div class="track-title" id="currentTrackTitle">No track selected</div>
                <div class="track-artist" id="currentTrackArtist">Select a song from your playlist</div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn" id="prevBtn">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-btn play-pause" id="playPauseBtn">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="nextBtn">
                    <i class="fas fa-step-forward"></i>
                </button>
            </div>

            <div class="volume-container">
                <i class="fas fa-volume-down"></i>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100">
                <i class="fas fa-volume-up"></i>
            </div>
        </section>

        <section class="playlist-section">
            <div class="playlist-header">
                <h2 class="playlist-title">Playlist</h2>
                <span class="playlist-count" id="playlistCount">0 tracks</span>
            </div>
            <div id="playlist" class="playlist">
                <div class="empty-state">
                    <i class="fas fa-music"></i>
                    <h3>No music uploaded yet</h3>
                    <p>Upload your first track to get started</p>
                </div>
            </div>
        </section>

        <audio id="audioPlayer" preload="metadata"></audio>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCmFq5ISq59Ql84Ntf_QiynlQtMX31zmwo",
            authDomain: "fuck-musix.firebaseapp.com",
            projectId: "fuck-musix",
            storageBucket: "fuck-musix.firebasestorage.app",
            messagingSenderId: "858119028230",
            appId: "1:858119028230:web:63dc3168ac63221a82cd87",
            databaseURL: "https://fuck-musix-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Configure Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('profile');
        googleProvider.addScope('email');

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloud_name: 'dgy5bftjt',
            api_key: '653338899368839',
            api_secret: 'Hv8eC6PZk7wgGRdBc9UnVDT9SPI'
        };

        // Application State
        let playlist = [];
        let currentTrackIndex = -1;
        let isPlaying = false;
        let currentAudio = null;
        let currentUser = null;

        // DOM Elements
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const currentTime = document.getElementById('currentTime');
        const totalTime = document.getElementById('totalTime');
        const volumeSlider = document.getElementById('volumeSlider');
        const currentTrackTitle = document.getElementById('currentTrackTitle');
        const currentTrackArtist = document.getElementById('currentTrackArtist');
        const playlistElement = document.getElementById('playlist');
        const playlistCount = document.getElementById('playlistCount');
        
        // Auth Elements
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const loginContainer = document.getElementById('loginContainer');
        const userContainer = document.getElementById('userContainer');
        const userPhoto = document.getElementById('userPhoto');
        const userName = document.getElementById('userName');

        // Initialize Cloudinary Upload Widget
        const uploadWidget = cloudinary.createUploadWidget({
            cloudName: cloudinaryConfig.cloud_name,
            uploadPreset: 'ml_default', // You may need to create an unsigned upload preset
            resourceType: 'auto',
            clientAllowedFormats: ['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac'],
            maxFileSize: 50000000, // 50MB
            multiple: false,
            folder: 'full-musix'
        }, (error, result) => {
            if (!error && result && result.event === "success") {
                handleUploadSuccess(result.info);
            } else if (error) {
                handleUploadError(error);
            }
        });

        // Upload button event listener
        uploadBtn.addEventListener('click', () => {
            uploadWidget.open();
        });

        // Handle successful upload
        async function handleUploadSuccess(uploadResult) {
            try {
                showUploadStatus('Saving to database...', 'loading');
                
                const trackData = {
                    id: Date.now().toString(),
                    title: uploadResult.original_filename || 'Unknown Track',
                    artist: 'Unknown Artist',
                    url: uploadResult.secure_url,
                    duration: uploadResult.duration || 0,
                    publicId: uploadResult.public_id,
                    uploadedAt: new Date().toISOString()
                };

                // Save to Firebase (user-specific)
                if (currentUser) {
                    await database.ref(`users/${currentUser.uid}/tracks`).push(trackData);
                } else {
                    await database.ref('tracks').push(trackData);
                }
                
                showUploadStatus('Track uploaded successfully!', 'success');
                
                // Refresh playlist
                loadPlaylist();
                
            } catch (error) {
                console.error('Error saving track:', error);
                handleUploadError(error);
            }
        }

        // Handle upload error
        function handleUploadError(error) {
            console.error('Upload error:', error);
            showUploadStatus('Upload failed. Please try again.', 'error');
        }

        // Show upload status
        function showUploadStatus(message, type) {
            uploadStatus.innerHTML = '';
            
            const statusDiv = document.createElement('div');
            statusDiv.className = type === 'error' ? 'error-message' : 
                                 type === 'success' ? 'success-message' : 
                                 'loading';
            
            if (type === 'loading') {
                statusDiv.innerHTML = `
                    <div class="spinner"></div>
                    <span>${message}</span>
                `;
            } else {
                statusDiv.textContent = message;
            }
            
            uploadStatus.appendChild(statusDiv);
            
            if (type !== 'loading') {
                setTimeout(() => {
                    uploadStatus.innerHTML = '';
                }, 5000);
            }
        }

        // Load playlist from Firebase
        async function loadPlaylist() {
            try {
                let snapshot;
                if (currentUser) {
                    snapshot = await database.ref(`users/${currentUser.uid}/tracks`).once('value');
                } else {
                    snapshot = await database.ref('tracks').once('value');
                }
                
                const tracks = snapshot.val();
                
                if (tracks) {
                    playlist = Object.keys(tracks).map(key => ({
                        firebaseKey: key,
                        ...tracks[key]
                    }));
                } else {
                    playlist = [];
                }
                
                renderPlaylist();
                updatePlaylistCount();
                
            } catch (error) {
                console.error('Error loading playlist:', error);
                showUploadStatus('Error loading playlist', 'error');
            }
        }

        // Render playlist
        function renderPlaylist() {
            if (playlist.length === 0) {
                playlistElement.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-music"></i>
                        <h3>No music uploaded yet</h3>
                        <p>Upload your first track to get started</p>
                    </div>
                `;
                return;
            }

            playlistElement.innerHTML = playlist.map((track, index) => `
                <div class="playlist-item ${index === currentTrackIndex ? 'active' : ''}" 
                     onclick="playTrack(${index})">
                    <i class="fas ${index === currentTrackIndex && isPlaying ? 'fa-pause' : 'fa-play'} play-icon"></i>
                    <div class="track-info">
                        <div class="track-name">${track.title}</div>
                        <div class="track-duration">${formatTime(track.duration)}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteTrack(event, '${track.firebaseKey}', ${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // Update playlist count
        function updatePlaylistCount() {
            playlistCount.textContent = `${playlist.length} track${playlist.length !== 1 ? 's' : ''}`;
        }

        // Play specific track
        function playTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            
            currentTrackIndex = index;
            const track = playlist[index];
            
            // Update UI
            currentTrackTitle.textContent = track.title;
            currentTrackArtist.textContent = track.artist;
            
            // Load audio
            audioPlayer.src = track.url;
            audioPlayer.load();
            
            // Play audio
            audioPlayer.play().then(() => {
                isPlaying = true;
                updatePlayPauseButton();
                renderPlaylist();
            }).catch(error => {
                console.error('Error playing audio:', error);
                showUploadStatus('Error playing track', 'error');
            });
        }

        // Play/Pause functionality
        playPauseBtn.addEventListener('click', () => {
            if (currentTrackIndex === -1 && playlist.length > 0) {
                playTrack(0);
                return;
            }
            
            if (isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
            } else {
                audioPlayer.play().then(() => {
                    isPlaying = true;
                }).catch(error => {
                    console.error('Error playing audio:', error);
                });
            }
            
            updatePlayPauseButton();
            renderPlaylist();
        });

        // Previous track
        prevBtn.addEventListener('click', () => {
            if (currentTrackIndex > 0) {
                playTrack(currentTrackIndex - 1);
            }
        });

        // Next track
        nextBtn.addEventListener('click', () => {
            if (currentTrackIndex < playlist.length - 1) {
                playTrack(currentTrackIndex + 1);
            }
        });

        // Update play/pause button
        function updatePlayPauseButton() {
            const icon = playPauseBtn.querySelector('i');
            icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
        }

        // Audio event listeners
        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = progress + '%';
                currentTime.textContent = formatTime(audioPlayer.currentTime);
                totalTime.textContent = formatTime(audioPlayer.duration);
            }
        });

        audioPlayer.addEventListener('ended', () => {
            isPlaying = false;
            updatePlayPauseButton();
            
            // Auto-play next track
            if (currentTrackIndex < playlist.length - 1) {
                playTrack(currentTrackIndex + 1);
            } else {
                renderPlaylist();
            }
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            totalTime.textContent = formatTime(audioPlayer.duration);
        });

        // Progress bar click
        progressBar.addEventListener('click', (e) => {
            if (audioPlayer.duration) {
                const rect = progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audioPlayer.currentTime = percent * audioPlayer.duration;
            }
        });

        // Volume control
        volumeSlider.addEventListener('input', (e) => {
            audioPlayer.volume = e.target.value / 100;
        });

        // Delete track
        async function deleteTrack(event, firebaseKey, index) {
            event.stopPropagation();
            
            if (!confirm('Are you sure you want to delete this track?')) {
                return;
            }
            
            try {
                // Remove from Firebase
                await database.ref(`tracks/${firebaseKey}`).remove();
                
                // If currently playing track is deleted
                if (index === currentTrackIndex) {
                    audioPlayer.pause();
                    isPlaying = false;
                    currentTrackIndex = -1;
                    currentTrackTitle.textContent = 'No track selected';
                    currentTrackArtist.textContent = 'Select a song from your playlist';
                    updatePlayPauseButton();
                } else if (index < currentTrackIndex) {
                    currentTrackIndex--;
                }
                
                // Reload playlist
                loadPlaylist();
                
                showUploadStatus('Track deleted successfully', 'success');
                
            } catch (error) {
                console.error('Error deleting track:', error);
                showUploadStatus('Error deleting track', 'error');
            }
        }

        // Format time helper
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadPlaylist();
            
            // Set initial volume
            audioPlayer.volume = 1;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    playPauseBtn.click();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    prevBtn.click();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextBtn.click();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    volumeSlider.value = Math.min(100, parseInt(volumeSlider.value) + 10);
                    volumeSlider.dispatchEvent(new Event('input'));
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    volumeSlider.value = Math.max(0, parseInt(volumeSlider.value) - 10);
                    volumeSlider.dispatchEvent(new Event('input'));
                    break;
            }
        });

        // Authentication Functions
        function signInWithGoogle() {
            auth.signInWithPopup(googleProvider)
                .then((result) => {
                    currentUser = result.user;
                    updateAuthUI();
                    loadPlaylist();
                    showUploadStatus('Welcome back! Your music library is now available.', 'success');
                })
                .catch((error) => {
                    console.error('Error signing in:', error);
                    showUploadStatus('Sign in failed. Please try again.', 'error');
                });
        }

        function signOut() {
            auth.signOut()
                .then(() => {
                    currentUser = null;
                    playlist = [];
                    updateAuthUI();
                    renderPlaylist();
                    updatePlaylistCount();
                    showUploadStatus('Signed out successfully.', 'success');
                })
                .catch((error) => {
                    console.error('Error signing out:', error);
                });
        }

        function updateAuthUI() {
            if (currentUser) {
                loginContainer.style.display = 'none';
                userContainer.style.display = 'block';
                userPhoto.src = currentUser.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM3YzNhZWQiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTRDOC42ODYyOSAxNCA2IDE2LjY4NjMgNiAyMFYyMkgxOFYyMEMxOCAxNi42ODYzIDE1LjMxMzcgMTQgMTIgMTRaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+';
                userName.textContent = currentUser.displayName || currentUser.email;
                uploadBtn.disabled = false;
            } else {
                loginContainer.style.display = 'block';
                userContainer.style.display = 'none';
                uploadBtn.disabled = true;
            }
        }

        // Auth Event Listeners
        googleSignInBtn.addEventListener('click', signInWithGoogle);
        signOutBtn.addEventListener('click', signOut);

        // Monitor auth state changes
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            updateAuthUI();
            if (user) {
                loadPlaylist();
            } else {
                playlist = [];
                renderPlaylist();
                updatePlaylistCount();
            }
        });

        // Delete track function with user-specific path
        async function deleteTrack(event, firebaseKey, index) {
            event.stopPropagation();
            
            if (!confirm('Are you sure you want to delete this track?')) return;
            
            try {
                let ref;
                if (currentUser) {
                    ref = database.ref(`users/${currentUser.uid}/tracks/${firebaseKey}`);
                } else {
                    ref = database.ref(`tracks/${firebaseKey}`);
                }
                
                await ref.remove();
                
                // Update playlist
                playlist.splice(index, 1);
                
                // Adjust current track index if necessary
                if (index === currentTrackIndex) {
                    // If current track was deleted, stop playback
                    audioPlayer.pause();
                    isPlaying = false;
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    currentTrackIndex = -1;
                    currentTrackTitle.textContent = 'No track selected';
                    currentTrackArtist.textContent = 'Select a song from your playlist';
                } else if (index < currentTrackIndex) {
                    currentTrackIndex--;
                }
                
                renderPlaylist();
                updatePlaylistCount();
                showUploadStatus('Track deleted successfully', 'success');
                
            } catch (error) {
                console.error('Error deleting track:', error);
                showUploadStatus('Error deleting track', 'error');
            }
        }

        // Initialize the app
        updateAuthUI();
    </script>
</body>
</html>
